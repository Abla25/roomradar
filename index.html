<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RoomRadar - Find Student Rooms & Apartments in Barcelona, Rome & London | University Housing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  
  <!-- SEO Meta Tags -->
  <meta name="description" content="Find affordable student rooms and apartments in Barcelona, Rome, and London. RoomRadar helps university students discover verified accommodation with detailed listings, photos, and reliable properties. Perfect for Erasmus, exchange students, and international students.">
  <meta name="keywords" content="student housing, university accommodation, student rooms Barcelona, student apartments Rome, student housing London, Erasmus accommodation, international student housing, affordable student rooms, university housing, student rental, Barcelona student housing, Rome student accommodation, London student rooms, student flat share, university room rental">
  <meta name="author" content="RoomRadar">
  <meta name="robots" content="index, follow">
  <meta name="language" content="English">
  <meta name="revisit-after" content="7 days">
  <meta name="distribution" content="global">
  <meta name="rating" content="general">
  
  <!-- Additional SEO Meta Tags -->
  <meta name="subject" content="Student Housing, University Accommodation">
  <meta name="category" content="Real Estate, Student Services">
  <meta name="coverage" content="Barcelona, Rome, London">
  <meta name="target" content="University Students, Erasmus Students, International Students">
  <meta name="audience" content="Students, University Students, International Students">
  <meta name="google-site-verification" content="your-verification-code">
  <meta name="msvalidate.01" content="your-bing-verification-code">
  <meta name="yandex-verification" content="your-yandex-verification-code">
  <meta name="baidu-site-verification" content="your-baidu-verification-code">
  <meta name="360-site-verification" content="your-360-verification-code">
  <meta name="sogou-site-verification" content="your-sogou-verification-code">
  <meta name="geo.region" content="EU">
  <meta name="geo.placename" content="Barcelona, Rome, London">
  <meta name="geo.position" content="41.3851;2.1734">
  <meta name="ICBM" content="41.3851, 2.1734">
  
  <!-- Mobile and App SEO -->
  <meta name="application-name" content="RoomRadar">
  <meta name="apple-mobile-web-app-title" content="RoomRadar">
  <meta name="msapplication-TileColor" content="#3B82F6">
  <meta name="theme-color" content="#3B82F6">
  <meta name="color-scheme" content="light dark">
  
  <!-- Local Business SEO -->
  <meta name="geo.region" content="ES">
  <meta name="geo.region" content="IT">
  <meta name="geo.region" content="GB">
  <meta name="geo.placename" content="Barcelona, Spain">
  <meta name="geo.placename" content="Rome, Italy">
  <meta name="geo.placename" content="London, UK">
  
  <!-- Multilingual SEO -->
  <meta name="description" lang="en" content="Find affordable student rooms and apartments in Barcelona, Rome, and London. RoomRadar helps university students discover verified accommodation with detailed listings, photos, and reliable properties. Perfect for Erasmus, exchange students, and international students.">
  <meta name="description" lang="es" content="Encuentra habitaciones y apartamentos para estudiantes asequibles en Barcelona, Roma y Londres. RoomRadar ayuda a estudiantes universitarios a descubrir alojamiento verificado con listados detallados, fotos y propiedades confiables. Perfecto para Erasmus, estudiantes de intercambio y estudiantes internacionales.">
  <meta name="description" lang="it" content="Trova camere e appartamenti per studenti economici a Barcellona, Roma e Londra. RoomRadar aiuta gli studenti universitari a scoprire alloggi verificati con annunci dettagliati, foto e proprietà affidabili. Perfetto per Erasmus, studenti di scambio e studenti internazionali.">
  
  <!-- Language-specific titles -->
  <meta name="title" lang="en" content="RoomRadar - Find Student Rooms & Apartments in Barcelona, Rome & London | University Housing">
  <meta name="title" lang="es" content="RoomRadar - Encuentra Habitaciones y Apartamentos para Estudiantes en Barcelona, Roma y Londres | Alojamiento Universitario">
  <meta name="title" lang="it" content="RoomRadar - Trova Camere e Appartamenti per Studenti a Barcellona, Roma e Londra | Alloggi Universitari">
  
  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="RoomRadar - Find Student Rooms & Apartments in Barcelona, Rome & London">
  <meta property="og:description" content="Find affordable student rooms and apartments in Barcelona, Rome, and London. Perfect for Erasmus, exchange students, and international students.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://roomradar.com">
  <meta property="og:image" content="https://roomradar.com/assets/images/roomradar-social-share.jpg">
  <meta property="og:image:secure_url" content="https://roomradar.com/assets/images/roomradar-social-share.jpg">
  <meta property="og:site_name" content="RoomRadar">
  <meta property="og:locale" content="en_US">
  <meta property="og:locale:alternate" content="es_ES">
  <meta property="og:locale:alternate" content="it_IT">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:image:alt" content="RoomRadar - Student Housing Platform for Barcelona, Rome and London">
  <meta property="og:image:type" content="image/jpeg">
  
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="RoomRadar - Student Housing in Barcelona, Rome & London">
  <meta name="twitter:description" content="Find affordable student rooms and apartments in Barcelona, Rome, and London. Perfect for Erasmus and international students.">
  <meta name="twitter:image" content="https://roomradar.com/assets/images/roomradar-social-share.jpg">
  <meta name="twitter:image:alt" content="RoomRadar - Student Housing Platform for Barcelona, Rome and London">
  <meta name="twitter:site" content="@roomradar">
  <meta name="twitter:creator" content="@roomradar">
  
  <!-- Reddit and other social media -->
  <meta name="reddit:title" content="RoomRadar - Student Housing in Barcelona, Rome & London">
  <meta name="reddit:description" content="Find affordable student rooms and apartments in Barcelona, Rome, and London. Perfect for Erasmus and international students.">
  
  <!-- LinkedIn -->
  <meta property="linkedin:title" content="RoomRadar - Student Housing Platform">
  <meta property="linkedin:description" content="Find affordable student rooms and apartments in Barcelona, Rome, and London. Perfect for Erasmus and international students.">
  
  <!-- Pinterest -->
  <meta name="pinterest:title" content="RoomRadar - Student Housing">
  <meta name="pinterest:description" content="Find affordable student rooms and apartments in Barcelona, Rome, and London">
  
  <!-- Canonical URL -->
  <link rel="canonical" href="https://roomradar.com">
  
  <!-- Alternate Language Links -->
  <link rel="alternate" hreflang="en" href="https://roomradar.com">
  <link rel="alternate" hreflang="es" href="https://roomradar.com/es">
  <link rel="alternate" hreflang="it" href="https://roomradar.com/it">
  <link rel="alternate" hreflang="x-default" href="https://roomradar.com">
  
  <!-- Sitemap -->
  <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml">
  
  <!-- Preconnect to external domains for performance -->
  <link rel="preconnect" href="https://www.gstatic.com">
  <link rel="preconnect" href="https://www.googleapis.com">
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  <link rel="dns-prefetch" href="https://www.googleapis.com">
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <link rel="alternate icon" href="assets/favicon.svg">
  
  <!-- Cache Control -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <!-- Performance and Security -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  
  <!-- Stylesheets -->
  <link rel="stylesheet" href="assets/css/cookie-banner.css">
  <link rel="stylesheet" href="assets/css/footer.css">
  <link rel="stylesheet" href="assets/css/navbar.css">
  
  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "RoomRadar",
    "description": "Find affordable student rooms and apartments in Barcelona, Rome, and London. Perfect for Erasmus, exchange students, and international students.",
    "url": "https://roomradar.com",
    "potentialAction": {
      "@type": "SearchAction",
      "target": "https://roomradar.com/?city={search_term_string}",
      "query-input": "required name=search_term_string"
    },
    "sameAs": [
      "https://roomradar.com"
    ],
    "inLanguage": ["en", "es", "it"],
    "audience": {
      "@type": "Audience",
      "audienceType": "University Students"
    }
  }
  </script>
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "RoomRadar",
    "url": "https://roomradar.com",
    "logo": "https://roomradar.com/assets/favicon.svg",
    "description": "Student housing platform for Barcelona, Rome, and London",
    "address": {
      "@type": "PostalAddress",
      "addressCountry": "EU"
    },
    "serviceArea": [
      {
        "@type": "City",
        "name": "Barcelona",
        "description": "Student accommodation in Barcelona"
      },
      {
        "@type": "City", 
        "name": "Rome",
        "description": "Student accommodation in Rome"
      },
      {
        "@type": "City",
        "name": "London",
        "description": "Student accommodation in London"
      }
    ],
    "serviceType": "Student Housing",
    "audience": {
      "@type": "Audience",
      "audienceType": "University Students"
    }
  }
  </script>
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "RealEstateAgent",
    "name": "RoomRadar",
    "description": "Student housing platform for Barcelona, Rome, and London",
    "url": "https://roomradar.com",
    "areaServed": [
      {
        "@type": "City",
        "name": "Barcelona"
      },
      {
        "@type": "City",
        "name": "Rome"
      },
      {
        "@type": "City",
        "name": "London"
      }
    ],
    "serviceType": "Student Housing",
    "audience": {
      "@type": "Audience",
      "audienceType": "University Students"
    }
  }
  </script>
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": [
      {
        "@type": "Question",
        "name": "How do I find student accommodation in Barcelona?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Use RoomRadar to search for verified student rooms and apartments in Barcelona. Filter by zone, price, and reliability rating to find the perfect accommodation for your university studies."
        }
      },
      {
        "@type": "Question",
        "name": "What is the best area for student housing in Rome?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Popular student areas in Rome include San Lorenzo, Trastevere, and Testaccio. Use our zone filters to explore different neighborhoods and find accommodation near your university."
        }
      },
      {
        "@type": "Question",
        "name": "How much does student accommodation cost in London?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Student accommodation in London varies by area. Use our price filters to find rooms within your budget, typically ranging from £600-1200 per month depending on location and facilities."
        }
      }
    ]
  }
  </script>
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Place",
    "name": "Barcelona",
    "description": "Student accommodation in Barcelona, Spain",
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "Barcelona",
      "addressCountry": "ES"
    },
    "hasOfferCatalog": {
      "@type": "OfferCatalog",
      "name": "Student Housing Barcelona",
      "itemListElement": [
        {
          "@type": "Offer",
          "itemOffered": {
            "@type": "Service",
            "name": "Student Room Rental Barcelona",
            "description": "Affordable student rooms and apartments in Barcelona"
          }
        }
      ]
    }
  }
  </script>
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Place",
    "name": "Rome",
    "description": "Student accommodation in Rome, Italy",
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "Rome",
      "addressCountry": "IT"
    },
    "hasOfferCatalog": {
      "@type": "OfferCatalog",
      "name": "Student Housing Rome",
      "itemListElement": [
        {
          "@type": "Offer",
          "itemOffered": {
            "@type": "Service",
            "name": "Student Room Rental Rome",
            "description": "Affordable student rooms and apartments in Rome"
          }
        }
      ]
    }
  }
  </script>
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Place",
    "name": "London",
    "description": "Student accommodation in London, UK",
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "London",
      "addressCountry": "GB"
    },
    "hasOfferCatalog": {
      "@type": "OfferCatalog",
      "name": "Student Housing London",
      "itemListElement": [
        {
          "@type": "Offer",
          "itemOffered": {
            "@type": "Service",
            "name": "Student Room Rental London",
            "description": "Affordable student rooms and apartments in London"
          }
        }
      ]
    }
  }
  </script>
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Home",
        "item": "https://roomradar.com"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": "Student Housing",
        "item": "https://roomradar.com"
      }
    ]
  }
  </script>
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "LocalBusiness",
    "name": "RoomRadar",
    "description": "Student housing platform for Barcelona, Rome, and London",
    "url": "https://roomradar.com",
    "telephone": "+34-XXX-XXX-XXX",
    "email": "info@roomradar.com",
    "address": {
      "@type": "PostalAddress",
      "addressCountry": "EU"
    },
    "areaServed": [
      {
        "@type": "City",
        "name": "Barcelona",
        "addressCountry": "ES"
      },
      {
        "@type": "City",
        "name": "Rome",
        "addressCountry": "IT"
      },
      {
        "@type": "City",
        "name": "London",
        "addressCountry": "GB"
      }
    ],
    "serviceType": "Student Housing",
    "priceRange": "€€",
    "openingHours": "Mo-Su 00:00-23:59"
  }
  </script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'SF Pro Display', Roboto, sans-serif;
      background: #ffffff;
      color: #374151;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    /* Header Styles */
    header {
      background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
      border-bottom: 1px solid rgba(226, 232, 240, 0.8);
      padding: 3rem 0 4rem 0;
      margin-bottom: 2rem;
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(ellipse 800px 600px at 50% -200px, rgba(59, 130, 246, 0.03) 0%, transparent 50%),
        radial-gradient(circle 300px at 20% 20%, rgba(16, 185, 129, 0.02) 0%, transparent 50%),
        radial-gradient(circle 200px at 80% 80%, rgba(139, 92, 246, 0.015) 0%, transparent 50%);
      pointer-events: none;
      animation: headerGlow 8s ease-in-out infinite;
    }

    header::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        linear-gradient(45deg, transparent 30%, rgba(59, 130, 246, 0.008) 50%, transparent 70%);
      pointer-events: none;
      animation: headerSweep 12s linear infinite;
    }

    /* Interactive cursor particles */
    .header-particles {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 1;
    }

    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.8) 0%, rgba(59, 130, 246, 0.3) 50%, transparent 100%);
      border-radius: 50%;
      pointer-events: none;
      transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      opacity: 0.4;
      transform: scale(1);
    }

    .particle.active {
      opacity: 1;
      transform: scale(1.5);
      box-shadow: 0 0 12px rgba(59, 130, 246, 0.5);
    }

    .icon-particle {
      position: absolute;
      width: 16px;
      height: 16px;
      pointer-events: none;
      opacity: 0;
      transform: scale(0) rotate(0deg);
      transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      color: #3B82F6;
      filter: drop-shadow(0 2px 4px rgba(59, 130, 246, 0.3));
    }

    .icon-particle.active {
      opacity: 1;
      transform: scale(1) rotate(180deg);
    }

    /* City Search Bar Styles - Minimal Liquid Glass */
    .city-search-container {
      transition: all 0.3s ease;
      position: relative;
    }

    .city-search-container:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 6px 24px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
      background: rgba(255, 255, 255, 0.7);
    }

    .city-search-container:hover .magnifier-effect {
      opacity: 1;
    }

    /* Current City Display Styles */
    .current-city-display {
      transition: all 0.3s ease;
    }

    .current-city-display:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.12);
      background: rgba(255, 255, 255, 0.9);
    }

    .current-city-display button:hover {
      background: rgba(59, 130, 246, 0.15);
      transform: scale(1.05);
    }

    #city-select {
      transition: all 0.3s ease;
    }

    #city-select:focus {
      outline: none;
      border-color: rgba(59, 130, 246, 0.6);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15), 0 4px 16px rgba(59, 130, 246, 0.2);
      transform: translateY(-1px);
    }

    #city-select:hover {
      border-color: rgba(59, 130, 246, 0.4);
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.15);
    }

    #search-btn {
      transition: all 0.3s ease;
      position: relative;
    }

    #search-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
      background: linear-gradient(135deg, #2563EB, #1E40AF);
    }

    #search-btn:hover .search-btn-shine {
      left: 100%;
    }

    #search-btn:active {
      transform: translateY(0);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    #search-btn:not([style*="pointer-events: none"]) {
      animation: pulse-glow 2s ease-in-out infinite;
      cursor: pointer;
    }

    #search-btn:not([style*="pointer-events: none"]):hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 12px 32px rgba(59, 130, 246, 0.5);
    }

    @keyframes pulse-glow {
      0%, 100% {
        box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
      }
      50% {
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.5);
      }
    }

    @keyframes fadeInUp {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .current-city-display {
      transition: all 0.3s ease;
    }

    .current-city-display:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }

    /* Responsive styles */
    @media (max-width: 768px) {
      .city-search-container {
        flex-direction: row;
        gap: 0.75rem;
        max-width: 90%;
        margin: 1.5rem auto 1rem auto;
        padding: 1rem;
        border-radius: 12px;
      }
      
      .city-selector {
        max-width: 70% !important;
        flex: 1;
      }
      
      #search-btn {
        width: auto;
        min-width: 48px;
        padding: 0.75rem;
        font-size: 0.85rem;
        justify-content: center;
      }
      
      #search-btn span {
        display: none;
      }
      
      #city-select {
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
        border-radius: 10px;
      }
    }
    
    @media (max-width: 480px) {
      .city-search-container {
        max-width: 95%;
        padding: 0.75rem;
        gap: 0.5rem;
      }
      
      .city-selector {
        max-width: 75% !important;
      }
      
      #search-btn {
        min-width: 44px;
        padding: 0.6rem;
        font-size: 0.8rem;
      }
      
      #search-btn span {
        display: none;
      }
      
      #city-select {
        padding: 0.6rem 0.8rem;
        font-size: 0.85rem;
      }
      
      .help-text {
        font-size: 0.8rem;
        margin: 0.5rem 0;
      }
    }

    .icon-particle {
      animation: iconFloat 2s ease-out forwards;
    }

    .icon-particle.house {
      color: #10B981;
    }

    .icon-particle.radar {
      color: #8B5CF6;
    }

    .icon-particle.star {
      color: #F59E0B;
    }

    @keyframes iconFloat {
      0% {
        transform: scale(1) rotate(180deg) translateY(0px);
        opacity: 1;
      }
      100% {
        transform: scale(0.3) rotate(360deg) translateY(-40px);
        opacity: 0;
      }
    }

    /* Ambient floating icons */
    .ambient-icon {
      position: absolute;
      width: 12px;
      height: 12px;
      pointer-events: none;
      opacity: 0.5;
      transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
      transform: scale(1) rotate(0deg);
    }

    .ambient-icon.attracted {
      opacity: 0.9;
      transform: scale(1.4) rotate(15deg);
      filter: drop-shadow(0 4px 8px rgba(59, 130, 246, 0.3));
    }

    /* Magnetic field effect */
    .magnetic-field {
      position: absolute;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, rgba(16, 185, 129, 0.05) 50%, transparent 100%);
      pointer-events: none;
      opacity: 0;
      transition: all 0.3s ease;
      transform: scale(0.8);
      z-index: 0;
    }

    .magnetic-field.active {
      opacity: 1;
      transform: scale(1.2);
      animation: magneticPulse 2s ease-in-out infinite;
    }

    @keyframes magneticPulse {
      0%, 100% { 
        transform: scale(1.2);
        opacity: 0.3;
      }
      50% { 
        transform: scale(1.5);
        opacity: 0.1;
      }
    }

    @keyframes headerGlow {
      0%, 100% { 
        opacity: 0.3; 
        transform: scale(1) rotate(0deg);
      }
      50% { 
        opacity: 0.6; 
        transform: scale(1.05) rotate(1deg);
      }
    }

    @keyframes headerSweep {
      0% { transform: translateX(-100%) rotate(-5deg); }
      100% { transform: translateX(200%) rotate(5deg); }
    }



    .header-content {
      position: relative;
      z-index: 2;
      text-align: center;
      animation: fadeInUp 0.8s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header-logo {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 80px;
      height: 80px;
      margin-bottom: 1.5rem;
      transition: all 0.3s ease;
      position: relative;
    }

    .header-logo:hover {
      transform: translateY(-2px);
    }

    .header-logo-icon {
      width: 60px;
      height: 60px;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    h1 {
      font-size: 3.5rem;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 0.75rem;
      letter-spacing: -0.02em;
      position: relative;
    }

    .header-subtitle {
      font-size: 1rem;
      color: #64748b;
      font-weight: 400;
      margin-top: 0.25rem;
      position: relative;
    }

    .header-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(59, 130, 246, 0.1);
      color: #3B82F6;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      margin-top: 1.5rem;
      border: 1px solid rgba(59, 130, 246, 0.2);
      animation: fadeIn 1s ease-out 0.5s both;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .header-badge-icon {
      width: 8px;
      height: 8px;
      background: #10B981;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.2); }
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
      margin-bottom: 4rem;
    }

    /* Filters Section */
    .filters {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(15, 23, 42, 0.06);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 20px rgba(15, 23, 42, 0.04);
      transition: all 0.3s ease;
      animation: slideInFromTop 0.6s ease-out 0.2s both;
    }

    @keyframes slideInFromTop {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .filters:hover {
      box-shadow: 0 8px 30px rgba(15, 23, 42, 0.08);
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .filter-group label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.75rem;
    }

    .filter-group input,
    .filter-group select {
      width: 100%;
      padding: 1rem 1.25rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 16px;
      background: #ffffff;
      font-size: 0.9rem;
      font-family: inherit;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: #374151;
    }

    .filter-group input::placeholder {
      color: #9ca3af;
      font-weight: 400;
    }

    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: #3B82F6;
      box-shadow: 
        0 0 0 3px rgba(59, 130, 246, 0.1),
        0 4px 12px rgba(59, 130, 246, 0.15);
      transform: translateY(-1px);
    }

    .filter-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 2rem;
      align-items: end;
      margin-bottom: 2rem;
    }

    .filter-row.secondary {
      border-top: 1px solid #e5e7eb;
      padding-top: 2rem;
      margin-bottom: 0;
    }

    /* Active Filters */
    .active-filters {
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid #e5e7eb;
      display: none;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        height: 0;
      }
      to {
        opacity: 1;
        height: auto;
      }
    }

    .active-filters.show {
      display: block;
    }

    .active-filters-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .active-filters-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
    }

    .clear-filters {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      border: none;
      color: white;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      padding: 0.5rem 1rem;
      border-radius: 12px;
      transition: all 0.2s ease;
      font-family: inherit;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .clear-filters:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
    }

    .filter-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .filter-tag {
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
      color: #1d4ed8;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border: 1px solid rgba(29, 78, 216, 0.2);
      transition: all 0.2s ease;
      animation: bounceIn 0.3s ease-out;
    }

    @keyframes bounceIn {
      0% { opacity: 0; transform: scale(0.8); }
      60% { transform: scale(1.1); }
      100% { opacity: 1; transform: scale(1); }
    }

    .filter-tag:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(29, 78, 216, 0.3);
    }

    .filter-tag .remove-filter {
      background: none;
      border: none;
      color: #1d4ed8;
      cursor: pointer;
      padding: 0;
      font-size: 16px;
      line-height: 1;
      opacity: 0.7;
      transition: all 0.2s ease;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .filter-tag .remove-filter:hover {
      opacity: 1;
      background: rgba(29, 78, 216, 0.1);
      transform: rotate(90deg);
    }

    /* Advanced Controls */
    .advanced-controls {
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1.5rem;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .control-group label {
      font-size: 0.875rem;
      font-weight: 600;
      color: #6b7280;
      white-space: nowrap;
    }

    .control-group select {
      padding: 0.75rem 1rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 12px;
      background: #ffffff;
      font-size: 0.875rem;
      font-family: inherit;
      font-weight: 500;
      transition: all 0.3s ease;
      min-width: 140px;
      color: #374151;
    }

    .control-group select:focus {
      outline: none;
      border-color: #3B82F6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Stats */
    .stats {
      text-align: center;
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border-radius: 20px;
      color: #374151;
      font-size: 0.9rem;
      font-weight: 500;
      border: 1px solid rgba(15, 23, 42, 0.08);
      animation: fadeInUp 0.6s ease-out 0.4s both;
    }

    /* Listings */
    .listings {
      display: flex;
      flex-direction: column;
      gap: 2.5rem !important;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(15, 23, 42, 0.06);
      border-radius: 12px;
      padding: 1rem;
      transition: all 0.3s ease;
      display: flex;
      gap: 1rem;
      position: relative;
      animation: cardSlideIn 0.6s ease-out both;
      width: 100%;
      max-width: 850px;
      margin: 0 auto 2rem auto;
    }

    .card:nth-child(even) {
      animation-delay: 0.1s;
    }

    .card:nth-child(odd) {
      animation-delay: 0.05s;
    }

    @keyframes cardSlideIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card:hover {
      border-color: rgba(59, 130, 246, 0.15);
      box-shadow: 0 8px 25px rgba(15, 23, 42, 0.08);
      transform: translateY(-2px);
    }

    .card-content {
      flex: 1;
      min-width: 0;
    }

    /* Thumbnail */
    .card-thumbnail {
      flex-shrink: 0;
      width: 130px;
      height: 98px;
      border-radius: 10px;
      overflow: hidden;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
    }

    .card-thumbnail:hover {
      border-color: #3B82F6;
      box-shadow: 
        0 8px 24px rgba(59, 130, 246, 0.2),
        0 4px 16px rgba(15, 23, 42, 0.1);
      transform: translateY(-2px) scale(1.02);
    }

    .card-thumbnail::after {
      content: '↗';
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      opacity: 0;
      transition: all 0.3s ease;
      transform: translateY(10px);
    }

    .card-thumbnail:hover::after,
    .card-thumbnail:focus::after {
      opacity: 1;
      transform: translateY(0);
    }

    .card-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: all 0.4s ease;
    }

    .card-thumbnail:hover img {
      transform: scale(1.05);
    }

    .card-thumbnail-placeholder {
      color: #9ca3af;
      font-size: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    }

    /* Card Header */
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
      position: relative;
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1f2937;
      margin: 0;
      flex: 1;
      margin-right: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      line-height: 1.3;
    }

    .card-title:hover {
      color: #3B82F6;
    }

    /* Rating */
    .card-rating {
      background: rgba(255, 243, 205, 0.8);
      color: #d68910;
      font-weight: 600;
      font-size: 0.8rem;
      padding: 0.35rem 0.7rem;
      border-radius: 10px;
      white-space: nowrap;
      flex-shrink: 0;
      position: relative;
      border: 1px solid rgba(214, 137, 16, 0.15);
      transition: all 0.2s ease;
    }

    .card-rating:hover {
      background: rgba(255, 243, 205, 1);
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 6px 16px rgba(214, 137, 16, 0.25);
      border-color: rgba(214, 137, 16, 0.3);
    }

    .card-rating.low {
      background: rgba(254, 226, 226, 0.8);
      color: #dc2626;
      border-color: rgba(220, 38, 38, 0.15);
    }

    .card-rating.low:hover {
      background: rgba(254, 226, 226, 1);
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 6px 16px rgba(220, 38, 38, 0.25);
      border-color: rgba(220, 38, 38, 0.3);
    }

    .card-rating.high {
      background: rgba(209, 250, 229, 0.8);
      color: #059669;
      border-color: rgba(5, 150, 105, 0.15);
    }

    .card-rating.high:hover {
      background: rgba(209, 250, 229, 1);
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 6px 16px rgba(5, 150, 105, 0.25);
      border-color: rgba(5, 150, 105, 0.3);
    }

    .rating-info {
      position: absolute;
      left: -24px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      background: rgba(255, 255, 255, 0.9);
      color: #6b7280;
      border: 1.5px solid #e5e7eb;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      cursor: help;
      transition: all 0.3s ease;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    .rating-info:hover {
      background: #ffffff;
      border-color: #3B82F6;
      color: #3B82F6;
      transform: translateY(-50%) scale(1.2);
    }

    .rating-tooltip {
      position: absolute;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      color: #374151;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.75rem;
      line-height: 1.2;
      max-width: 320px;
      min-width: 280px;
      white-space: normal;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 100;
      margin-bottom: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(15, 23, 42, 0.08);
      backdrop-filter: blur(10px);
      font-weight: 400;
    }

    .rating-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: rgba(255, 255, 255, 0.95);
    }

    .rating-info:hover .rating-tooltip,
    .card-rating:hover .rating-tooltip {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(-4px);
    }

    /* Meta Tags */
    .card-meta {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .meta-tag {
      background: rgba(248, 250, 252, 0.8);
      color: #374151;
      padding: 0.3rem 0.7rem;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 500;
      border: 1px solid rgba(15, 23, 42, 0.06);
      transition: all 0.2s ease;
    }

    .meta-tag:hover {
      background: rgba(248, 250, 252, 1);
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.15);
    }

    .meta-tag.zone {
      background: rgba(219, 234, 254, 0.8);
      color: #1d4ed8;
      border-color: rgba(29, 78, 216, 0.15);
    }

    .meta-tag.zone:hover {
      background: rgba(219, 234, 254, 1);
      border-color: rgba(29, 78, 216, 0.3);
      box-shadow: 0 4px 12px rgba(29, 78, 216, 0.2);
    }

    .meta-tag.price {
      background: rgba(209, 250, 229, 0.8);
      color: #059669;
      border-color: rgba(5, 150, 105, 0.15);
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      font-weight: 600;
    }

    .meta-tag.price:hover {
      background: rgba(209, 250, 229, 1);
      border-color: rgba(5, 150, 105, 0.3);
      box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2);
    }



    /* AI Overview */
    .card-overview-ai {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border-left: 3px solid #3B82F6;
      padding: 0.75rem 1rem;
      margin-bottom: 0.75rem;
      border-radius: 12px;
      position: relative;
      border: 1px solid rgba(59, 130, 246, 0.1);
    }

    .overview-ai-header {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      margin-bottom: 0.5rem;
      font-size: 0.7rem;
      color: #3B82F6;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .overview-ai-icon {
      width: 12px;
      height: 12px;
      transition: all 0.3s ease;
    }

    .card-overview-ai:hover .overview-ai-icon {
      animation: sparkle 0.6s ease-in-out;
      transform: scale(1.2);
    }

    @keyframes sparkle {
      0%, 100% { 
        transform: scale(1.2) rotate(0deg); 
        filter: brightness(1);
      }
      25% { 
        transform: scale(1.3) rotate(5deg); 
        filter: brightness(1.3);
      }
      50% { 
        transform: scale(1.4) rotate(-5deg); 
        filter: brightness(1.5);
      }
      75% { 
        transform: scale(1.3) rotate(3deg); 
        filter: brightness(1.2);
      }
    }

    .overview-ai-text {
      color: #374151;
      line-height: 1.4;
      font-size: 0.8rem;
      font-weight: 400;
      font-style: italic;
    }

    /* Date */
    .card-date {
      color: #6b7280;
      font-size: 0.85rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
    }

    .date-icon {
      width: 16px;
      height: 16px;
      opacity: 0.7;
    }

    /* Description */
    .card-description {
      color: #6b7280;
      margin-bottom: 1rem;
      line-height: 1.5;
      position: relative;
      font-weight: 400;
      font-size: 0.9rem;
    }

    /* Censored text styles */
    .censored-text {
      color: #9ca3af;
      border-bottom: 2px dotted #9ca3af;
      cursor: help;
      position: relative;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .censored-text:hover {
      color: #6b7280;
      border-bottom-color: #6b7280;
      background: rgba(156, 163, 175, 0.1);
      padding: 0 2px;
      border-radius: 3px;
    }

    .censored-tooltip {
      position: absolute;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      color: #374151;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.75rem;
      line-height: 1.2;
      max-width: 280px;
      min-width: 240px;
      white-space: normal;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 100;
      margin-bottom: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(15, 23, 42, 0.08);
      backdrop-filter: blur(10px);
      font-weight: 400;
      pointer-events: none;
    }

    .censored-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: rgba(255, 255, 255, 0.95);
    }

    .censored-text:hover .censored-tooltip {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(-4px);
    }


    .read-more-link {
      color: #3B82F6;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      margin-left: 0.5rem;
      text-decoration: none;
      transition: all 0.2s ease;
      border-bottom: 1px solid transparent;
    }

    .read-more-link:hover {
      color: #1d4ed8;
      border-bottom-color: #1d4ed8;
    }

    /* Actions */
    .card-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: inherit;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background: #3B82F6;
      color: white;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.1);
    }

    .btn-primary:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .favorite-btn {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      cursor: pointer;
      color: #6b7280;
    }

    .favorite-btn:hover {
      transform: scale(1.15);
      color: #ef4444;
    }

    .favorite-btn.favorited {
      color: #FF3B30;
    }

    .favorite-btn.favorited:hover {
      transform: scale(1.15);
      color: #dc2626;
    }

    .favorite-btn .favorite-icon {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .favorite-btn.favorited {
      fill: #FF3B30;
    }

    .favorite-btn:active {
      transform: scale(0.95);
    }

    /* Favorite button tooltip */
    .favorite-btn {
      position: relative;
    }

    .favorite-btn::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      color: #374151;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.75rem;
      line-height: 1.2;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 100;
      margin-bottom: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(15, 23, 42, 0.08);
      backdrop-filter: blur(10px);
      font-weight: 400;
      pointer-events: none;
    }

    .favorite-btn::before {
      content: '';
      position: absolute;
      bottom: 110%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: rgba(255, 255, 255, 0.95);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 100;
      pointer-events: none;
    }

    .favorite-btn:hover::after,
    .favorite-btn:hover::before {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(-4px);
    }

    /* Loading and Error States */
    .loading {
      text-align: center;
      padding: 6rem 2rem;
      color: #6b7280;
      font-weight: 500;
    }

    .loading::after {
      content: '';
      display: block;
      width: 40px;
      height: 40px;
      margin: 2rem auto 0;
      border: 3px solid #e5e7eb;
      border-top: 3px solid #3B82F6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      text-align: center;
      padding: 3rem 2rem;
      background: linear-gradient(135deg, #fef2f2, #fee2e2);
      border: 1px solid #fca5a5;
      border-radius: 20px;
      color: #dc2626;
      font-weight: 500;
    }

    .no-results {
      text-align: center;
      padding: 4rem 2rem;
      color: #6b7280;
      font-weight: 500;
    }

    /* Pagination */
    .pagination-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4rem;
      padding: 2rem 2.5rem;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 24px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 
        0 10px 40px rgba(15, 23, 42, 0.08),
        0 4px 16px rgba(15, 23, 42, 0.04);
      backdrop-filter: blur(20px);
    }

    .pagination-info {
      color: #374151;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .pagination-buttons {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .pagination-btn {
      padding: 0.875rem 1.5rem;
      border: 1.5px solid #e5e7eb;
      background: #ffffff;
      color: #374151;
      border-radius: 14px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-width: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .pagination-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
      transition: left 0.5s;
    }

    .pagination-btn:hover::before {
      left: 100%;
    }

    .pagination-btn:hover {
      border-color: #3B82F6;
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      color: #3B82F6;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.2);
    }

    .pagination-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      background: #f9fafb;
      color: #9ca3af;
      transform: none;
      box-shadow: none;
    }

    .pagination-btn:disabled:hover {
      border-color: #e5e7eb;
      background: #f9fafb;
      color: #9ca3af;
    }

    .pagination-btn.active {
      background: linear-gradient(135deg, #3B82F6, #1d4ed8);
      color: white;
      border-color: #3B82F6;
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
    }

    .pagination-btn.active:hover {
      background: linear-gradient(135deg, #1d4ed8, #1e40af);
      border-color: #1d4ed8;
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      .filter-row {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .container {
        max-width: 900px;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 0 1rem;
      }
      
      h1 {
        font-size: 2.5rem;
      }
      
      .header-logo {
        width: 60px;
        height: 60px;
      }
      
      .header-logo-icon {
        width: 40px;
        height: 40px;
      }
      
      .filter-row {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .filters {
        padding: 2rem;
        border-radius: 20px;
      }
      
      .advanced-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .card {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
        max-width: 100%;
      }
      
      .card-thumbnail {
        position: static;
        width: 100%;
        height: 180px;
        order: -1;
        border-radius: 10px;
      }
      
      .card-content {
        margin-right: 0;
      }
      
      .card-actions {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
      }
      
      .btn-primary {
        padding: 1rem;
        text-align: center;
        justify-content: center;
      }
      
      .pagination-controls {
        flex-direction: column;
        gap: 1.5rem;
        text-align: center;
        padding: 2rem;
      }
      
      .pagination-buttons {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .filter-tags {
        justify-content: center;
      }
      
      /* Tutorial cards responsive */
      #tutorial-cards {
        flex-direction: column;
        gap: 1rem;
      }
      
      .tutorial-card {
        min-width: auto;
        width: 100%;
      }
      

    }

    @media (max-width: 480px) {
      .container {
        padding: 0 0.75rem;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      .filters {
        padding: 1.5rem;
      }
      
      .card {
        padding: 1.25rem;
      }
      
      .card-title {
        font-size: 1.1rem;
      }
      
      pagination-btn {
        padding: 0.75rem 1rem;
        min-width: 40px;
      }
      
      /* Mobile dropdown fixes */
      .city-dropdown {
        position: relative;
        z-index: 1001;
      }
      
      .city-dropdown-menu {
        position: fixed !important;
        top: auto !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        width: 90% !important;
        max-width: 300px !important;
        margin-top: 0.5rem !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2) !important;
        border-radius: 16px !important;
        max-height: 60vh !important;
        overflow-y: auto !important;
      }
      
      .city-option {
        padding: 1rem !important;
        font-size: 1rem !important;
        min-height: 48px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      }
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f5f9;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #3B82F6, #10B981);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #1d4ed8, #059669);
    }

    /* Smooth page transitions */
    * {
      scroll-behavior: smooth;
    }

    /* Toast Notifications - Apple Style */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      pointer-events: none;
    }

    .toast {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 1rem 1.25rem;
      margin-bottom: 0.75rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      min-width: 280px;
      max-width: 320px;
      transform: translateX(400px);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      pointer-events: auto;
    }

    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }

    .toast.success {
      border-left: 4px solid #10B981;
    }

    .toast.error {
      border-left: 4px solid #EF4444;
    }

    .toast-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .toast.success .toast-icon {
      background: linear-gradient(135deg, #10B981, #059669);
      color: white;
    }

    .toast.error .toast-icon {
      background: linear-gradient(135deg, #EF4444, #DC2626);
      color: white;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      font-size: 0.9rem;
      color: #1F2937;
      margin-bottom: 0.125rem;
    }

    .toast-message {
      font-size: 0.8rem;
      color: #6B7280;
      line-height: 1.4;
    }

    .toast-close {
      background: none;
      border: none;
      color: #9CA3AF;
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 6px;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .toast-close:hover {
      background: rgba(0, 0, 0, 0.05);
      color: #6B7280;
    }

    @media (max-width: 768px) {
      .toast-container {
        top: 10px;
        right: 10px;
        left: 10px;
      }
      
      .toast {
        min-width: auto;
        max-width: none;
        width: 100%;
      }
    }

    /* Icon styles for better visual hierarchy */
    .icon {
      width: 18px;
      height: 18px;
      stroke: currentColor;
      stroke-width: 2;
      fill: none;
    }

    /* Left Actions Group */
    .left-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    /* Report Button Styles */
    .report-btn {
      background: none;
      border: none;
      color: #6b7280;
      font-size: 0.7rem;
      font-weight: 400;
      cursor: pointer;
      padding: 0;
      transition: color 0.2s ease;
      display: inline; /* Visible on desktop */
    }

    .report-btn:hover {
      color: #ef4444;
    }

    /* Mobile Report Button - Hidden on desktop */
    .report-btn-mobile {
      display: none;
      background: none;
      border: none;
      color: #6b7280;
      font-size: 0.7rem;
      font-weight: 400;
      cursor: pointer;
      padding: 0.5rem 0;
      margin-top: 1rem;
      transition: color 0.2s ease;
      text-align: center;
      width: 100%;
    }

    /* Hide mobile report button on desktop */
    @media (min-width: 769px) {
      .report-btn-mobile {
        display: none !important;
      }
    }

    .report-btn-mobile:hover {
      color: #ef4444;
    }

    /* Mobile Layout */
    @media (max-width: 768px) {
      .left-actions {
        width: 80%;
        gap: 0.5rem;
      }

      .left-actions .btn {
        flex: 1;
        min-width: 0;
      }

      .favorite-btn {
        width: 20%;
        min-width: auto;
        width: 24px;
        height: 24px;
      }

      /* Hide desktop report button on mobile */
      .report-btn {
        display: none !important;
      }

      /* Mobile report button visibility handled by JavaScript */
      .report-btn-mobile {
        /* Visibility controlled by JavaScript */
        display: block;
      }

      /* Card actions layout for mobile */
      .card-actions {
        flex-direction: row;
        gap: 1rem;
        align-items: center;
      }

      .card-actions .left-actions {
        width: 80%;
        display: flex;
        justify-content: flex-start;
        align-items: center;
      }

      .card-actions .favorite-btn {
        width: 20%;
        flex-shrink: 0;
      }
    }

    /* Report Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .report-modal {
      background: white;
      border-radius: 16px;
      padding: 0;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      transform: scale(0.9) translateY(20px);
      transition: all 0.3s ease;
    }

    .modal-overlay.show .report-modal {
      transform: scale(1) translateY(0);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.5rem 1.5rem 1rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
      color: #111827;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #6b7280;
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: #f3f4f6;
      color: #374151;
    }

    .modal-body {
      padding: 1.5rem;
    }

    .report-description {
      color: #6b7280;
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #374151;
    }

    .form-control {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 0.875rem;
      transition: border-color 0.2s ease;
      box-sizing: border-box;
      background-color: white;
      color: #374151;
    }

    .form-control:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
    }

    .form-actions .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #d1d5db;
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
      border: 1px solid #3b82f6;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

  </style>
</head>
<body>
  <!-- Toast Container -->
  <div id="toast-container" class="toast-container"></div>
  
  <!-- Navbar -->
  <div id="navbar-container"></div>

  <header>
    <div class="header-particles"></div>
    <div class="magnetic-field"></div>
    <div class="container">
      <div class="header-content">
        <div class="header-logo">
          <img src="vector-cropped-cropped (1).svg" alt="RoomRadar Logo" class="header-logo-icon" style="width: 60px; height: 60px;">
        </div>
        
        <h1>RoomRadar</h1>
        
        <p style="
          text-align: center;
          color: #64748b;
          font-size: 1.1rem;
          margin: 0 0 2rem 0;
          font-weight: 400;
          opacity: 0.9;
        ">Find affordable student accommodation in Barcelona, Rome & London</p>
        
        <!-- City Search Bar -->
        <div class="city-search-container" id="city-search-container" style="
          display: flex;
          align-items: center;
          gap: 1.5rem;
          margin: 2rem auto 1.5rem auto;
          justify-content: center;
          max-width: 500px;
          width: 100%;
          padding: 1.5rem;
          background: rgba(255, 255, 255, 0.6);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 16px;
          box-shadow: 
            0 4px 20px rgba(0, 0, 0, 0.06),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
          backdrop-filter: blur(16px);
          -webkit-backdrop-filter: blur(16px);
          position: relative;
          overflow: hidden;
        ">
          <!-- Magnifier effect -->
          <div class="magnifier-effect" style="
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
              radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), 
                rgba(255, 255, 255, 0.3) 0%, 
                transparent 60%);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
          "></div>
          <div class="city-selector" style="
            position: relative;
            flex: 1;
            max-width: 250px;
          ">
            <select id="city-select" style="
              width: 100%;
              padding: 1rem 1.25rem;
              border: 2px solid rgba(59, 130, 246, 0.15);
              border-radius: 16px;
              background: rgba(255, 255, 255, 0.98);
              color: #374151;
              font-size: 1rem;
              font-weight: 500;
              cursor: pointer;
              transition: all 0.3s ease;
              appearance: none;
              -webkit-appearance: none;
              background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="%23374151" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6,9 12,15 18,9"></polyline></svg>');
              background-repeat: no-repeat;
              background-position: right 1rem center;
              background-size: 14px;
              padding-right: 3rem;
              box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
            ">
              <option value="">🌍 Choose your city...</option>
              <option value="barcelona">🇪🇸 Barcelona</option>
              <option value="roma">🇮🇹 Rome</option>
              <option value="london">🇬🇧 London</option>
            </select>
          </div>
          
          <button id="search-btn" onclick="startCitySearch(true, true)" style="
            background: linear-gradient(135deg, #3B82F6, #1D4ED8);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            opacity: 0.6;
            pointer-events: none;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
            position: relative;
            overflow: hidden;
          ">
            <div class="search-btn-shine" style="
              position: absolute;
              top: 0;
              left: -100%;
              width: 100%;
              height: 100%;
              background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
              transition: left 0.5s ease;
            "></div>
            <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: none; stroke: currentColor; stroke-width: 2;">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            <span>Find Rooms</span>
          </button>
        </div>
        
        <!-- Help text -->

        
        <!-- Current City Display (shown after selection) -->
        <div class="current-city-display" id="current-city-display-container" style="
          display: none;
          align-items: center;
          gap: 1rem;
          margin-bottom: 1.5rem;
          justify-content: center;
          padding: 1rem 1.5rem;
          background: rgba(255, 255, 255, 0.8);
          border: 1px solid rgba(59, 130, 246, 0.15);
          border-radius: 16px;
          max-width: 320px;
          margin-left: auto;
          margin-right: auto;
          box-shadow: 0 2px 12px rgba(59, 130, 246, 0.08);
          backdrop-filter: blur(12px);
          -webkit-backdrop-filter: blur(12px);
          position: relative;
          overflow: hidden;
        ">
          <!-- Background glow -->
          <div style="
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.05) 0%, transparent 70%);
            pointer-events: none;
          "></div>
          
          <!-- City icon with flag -->
          <div style="
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(59, 130, 246, 0.2);
          ">
            <svg class="icon" viewBox="0 0 24 24" style="width: 18px; height: 18px; color: #3B82F6;">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" stroke="currentColor" fill="none" stroke-width="2"></path>
              <circle cx="12" cy="10" r="3" stroke="currentColor" fill="none" stroke-width="2"></circle>
            </svg>
          </div>
          
          <!-- City name and status -->
          <div style="
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
          ">
            <span id="current-city-text" style="
              color: #1f2937;
              font-weight: 600;
              font-size: 1rem;
            ">Barcelona</span>
            <span style="
              color: #6b7280;
              font-size: 0.75rem;
              font-weight: 500;
            ">Active listings</span>
          </div>
          
          <!-- Switch city button -->
          <button onclick="changeCity()" style="
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            color: #3B82F6;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            margin-left: auto;
            display: flex;
            align-items: center;
            justify-content: center;
          ">
            <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: none; stroke: currentColor; stroke-width: 2;">
              <path d="M7 16V4m0 0L3 8m4-4l4 4M17 8v12m0 0l4-4m-4 4l-4-4"/>
            </svg>
          </button>
        </div>
        
        <div class="header-badge">
          <div class="header-badge-icon"></div>
          Live Updates
        </div>
        

        
        <!-- Auth button moved to navbar -->
      </div>
    </div>
  </header>



  <div class="container">
    <div class="filters">
      <div class="filter-row">
        <div class="filter-group">
          <label>
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            Zone
          </label>
          <select id="filter-zone">
            <option value="">All zones</option>
          </select>
        </div>
        <div class="filter-group">
          <label>
            <svg class="icon" viewBox="0 0 24 24">
              <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon>
            </svg>
            Min. Reliability
          </label>
          <select id="filter-reliability">
            <option value="">All</option>
            <option value="1">≥ 1</option>
            <option value="2">≥ 2</option>
            <option value="3">≥ 3</option>
            <option value="4">≥ 4</option>
            <option value="5">≥ 5</option>
          </select>
        </div>
        <div class="filter-group">
          <label>
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
            Max Price (€)
          </label>
          <input type="number" id="filter-price" placeholder="e.g. 1200">
        </div>
        <div class="filter-group">
          <label>
            <svg class="icon" viewBox="0 0 24 24">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            Publication Date
          </label>
          <select id="filter-date">
            <option value="">All</option>
            <option value="1">Today</option>
            <option value="3">Last 3 days</option>
            <option value="7">Last week</option>
            <option value="30">Last month</option>
          </select>
        </div>
      </div>
      
      <div class="active-filters" id="active-filters">
        <div class="active-filters-header">
          <span class="active-filters-title">Active filters:</span>
          <button class="clear-filters" onclick="clearAllFilters()">
            <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
            Clear all
          </button>
        </div>
        <div class="filter-tags" id="filter-tags"></div>
      </div>
      
      <div class="advanced-controls">
        <div class="advanced-controls-left">
          <div class="control-group">
            <label>
              <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="7" y1="12" x2="21" y2="12"></line>
                <line x1="11" y1="18" x2="21" y2="18"></line>
              </svg>
              Sort by:
            </label>
            <select id="sort-by">
              <option value="date-desc">Date (newest)</option>
              <option value="date-asc">Date (oldest)</option>
              <option value="rating-desc">Rating (highest)</option>
              <option value="rating-asc">Rating (lowest)</option>
              <option value="price-asc">Price (ascending)</option>
              <option value="price-desc">Price (descending)</option>
            </select>
          </div>
          

        </div>
        
        <div class="advanced-controls-right">
          <div class="control-group">
            <label>Items per page:</label>
            <select id="items-per-page">
              <option value="10">10</option>
              <option value="20" selected>20</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div id="stats" class="stats" style="display: none;"></div>

    <div id="loading" class="loading">Loading amazing rooms for you...</div>
    
    <div id="listings" class="listings"></div>
    
    <div id="pagination" class="pagination-controls" style="display: none;"></div>
  </div>

  <!-- Footer -->
  <div id="footer-container"></div>

  <script src="assets/js/cookie-banner.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    // Import and inject Vercel Analytics
    import { inject } from '@vercel/analytics';
    inject();

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { initializeFavorites, handleFavoriteClick, updateFavoriteButtons } from "./assets/js/favorites.js";
    import { initializeReports, handleReportClick, closeReportModal, submitReport } from "./assets/js/reports.js";

    // Make report functions globally available
    window.handleReportClick = handleReportClick;
    window.closeReportModal = closeReportModal;
    window.submitReport = submitReport;

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBdheYPtK3xPq-MkochYgM8CCnJF3AFPXM",
      authDomain: "roomradar-auth.firebaseapp.com",
      projectId: "roomradar-auth",
      storageBucket: "roomradar-auth.firebasestorage.app",
      messagingSenderId: "167307746619",
      appId: "1:167307746619:web:f7c42efa80049d86046b1e",
      measurementId: "G-3135P792LN"
    };

    // Initialize Firebase
    console.log('🔥 Initializing Firebase...');
    console.log('Firebase config:', firebaseConfig);
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    console.log('✅ Firebase initialized successfully');
    console.log('Auth instance:', auth);
    console.log('Firestore instance:', db);

    // Make Firebase available globally
    window.firebase = { auth, db };
    window.auth = auth;
    window.db = db;

    // Global auth state
    let currentUser = null;
    window.currentUser = currentUser; // Make it globally accessible

    // Auth state listener with persistence
    onAuthStateChanged(auth, (user) => {
      console.log('🔄 Auth state changed:', user ? 'User logged in' : 'User logged out');
      currentUser = user;
      window.currentUser = user; // Update global reference
      
      // Initialize favorites system when user logs in
      if (user) {
        console.log('💖 Initializing favorites for user:', user.uid);
        initializeFavorites(auth).then(() => {
          // Update favorite buttons after favorites are initialized
          if (typeof updateFavoriteButtons === 'function') {
            updateFavoriteButtons();
          }
        });

          // Initialize reports system
          initializeReports(auth);
      }
      
      // Update UI after a short delay to ensure everything is loaded
      setTimeout(() => {
        updateAuthUI();
        // Update favorite buttons after auth state change
        if (typeof updateFavoriteButtons === 'function') {
          updateFavoriteButtons();
        }

      // Update report buttons visibility
      updateReportButtonsVisibility();
      }, 100);
    });

    // Update UI based on auth state - will be handled by the main updateAuthUI function



    // Close auth modal
    window.closeAuthModal = function() {
      const modal = document.getElementById('auth-modal');
      if (modal) modal.remove();
    };



    // Toggle email forms
    window.toggleEmailForm = function(formType) {
      const emailForm = document.getElementById(`${formType}-email-form`);
      const toggleBtn = document.getElementById(`${formType}-email-toggle`);
      
      if (emailForm.style.display === 'none') {
        emailForm.style.display = 'flex';
        toggleBtn.textContent = formType === 'signin' ? 'Back to Google Sign In' : 'Back to Google Sign Up';
        toggleBtn.style.background = '#f1f5f9';
        toggleBtn.style.color = '#475569';
      } else {
        emailForm.style.display = 'none';
        toggleBtn.textContent = formType === 'signin' ? 'Sign in with Email' : 'Sign up with Email';
        toggleBtn.style.background = '#f8fafc';
        toggleBtn.style.color = '#64748b';
      }
    };

    // Reset email forms to initial state
    function resetEmailForms() {
      const signinEmailForm = document.getElementById('signin-email-form');
      const signupEmailForm = document.getElementById('signup-email-form');
      const signinToggleBtn = document.getElementById('signin-email-toggle');
      const signupToggleBtn = document.getElementById('signup-email-toggle');
      
      if (signinEmailForm) {
        signinEmailForm.style.display = 'none';
        signinEmailForm.querySelectorAll('input').forEach(input => input.value = '');
      }
      if (signupEmailForm) {
        signupEmailForm.style.display = 'none';
        signupEmailForm.querySelectorAll('input').forEach(input => input.value = '');
      }
      if (signinToggleBtn) {
        signinToggleBtn.textContent = 'Sign in with Email';
        signinToggleBtn.style.background = '#f8fafc';
        signinToggleBtn.style.color = '#64748b';
      }
      if (signupToggleBtn) {
        signupToggleBtn.textContent = 'Sign up with Email';
        signupToggleBtn.style.background = '#f8fafc';
        signupToggleBtn.style.color = '#64748b';
      }
    }

    // Toggle email forms for inline forms
    window.toggleEmailFormInline = function(formType) {
      const emailForm = document.getElementById(`${formType}-email-form-inline`);
      const toggleBtn = document.getElementById(`${formType}-email-toggle-inline`);
      
      if (emailForm.style.display === 'none') {
        emailForm.style.display = 'flex';
        toggleBtn.textContent = formType === 'signin' ? 'Back to Google Sign In' : 'Back to Google Sign Up';
        toggleBtn.style.background = '#f1f5f9';
        toggleBtn.style.color = '#475569';
      } else {
        emailForm.style.display = 'none';
        toggleBtn.textContent = formType === 'signin' ? 'Sign in with Email' : 'Sign up with Email';
        toggleBtn.style.background = '#f8fafc';
        toggleBtn.style.color = '#64748b';
      }
    };

    // Reset email forms for inline forms
    function resetEmailFormsInline() {
      const signinEmailForm = document.getElementById('signin-email-form-inline');
      const signupEmailForm = document.getElementById('signup-email-form-inline');
      const signinToggleBtn = document.getElementById('signin-email-toggle-inline');
      const signupToggleBtn = document.getElementById('signup-email-toggle-inline');
      
      if (signinEmailForm) {
        signinEmailForm.style.display = 'none';
        signinEmailForm.querySelectorAll('input').forEach(input => input.value = '');
      }
      if (signupEmailForm) {
        signupEmailForm.style.display = 'none';
        signupEmailForm.querySelectorAll('input').forEach(input => input.value = '');
      }
      if (signinToggleBtn) {
        signinToggleBtn.textContent = 'Sign in with Email';
        signinToggleBtn.style.background = '#f8fafc';
        signinToggleBtn.style.color = '#64748b';
      }
      if (signupToggleBtn) {
        signupToggleBtn.textContent = 'Sign up with Email';
        signupToggleBtn.style.background = '#f8fafc';
        signupToggleBtn.style.color = '#64748b';
      }
    }

    // Sign in
    window.signIn = async function() {
      const email = document.getElementById('signin-email').value;
      const password = document.getElementById('signin-password').value;
      
      // Clear previous error messages
      clearAuthErrors();
      
      try {
        await signInWithEmailAndPassword(auth, email, password);
        closeAuthModal();
        showToast('success', 'Sign in successful', 'Welcome to RoomRadar! 🏠');
      } catch (error) {
        console.log('Sign in error:', error.code, error.message);
        
        // Check if user doesn't exist and auto-switch to signup
        if (error.code === 'auth/user-not-found') {
          // Switch to signup tab and pre-fill email
          switchAuthTab('signup');
          document.getElementById('signup-email').value = email;
          document.getElementById('signup-name').focus();
          showAuthError('signup', 'Account not found. We\'ve switched you to sign up with this email address.');
        } else if (error.code === 'auth/wrong-password') {
          showAuthError('signin', 'Incorrect password. Please check your password and try again.');
        } else if (error.code === 'auth/invalid-email') {
          showAuthError('signin', 'Invalid email format. Please enter a valid email address.');
        } else if (error.code === 'auth/too-many-requests') {
          showAuthError('signin', 'Too many failed attempts. Please wait a few minutes before trying again.');
        } else if (error.code === 'auth/user-disabled') {
          showAuthError('signin', 'This account has been disabled. Please contact support for assistance.');
        } else if (error.code === 'auth/network-request-failed') {
          showAuthError('signin', 'Network error. Please check your internet connection and try again.');
        } else if (error.code === 'auth/operation-not-allowed') {
          showAuthError('signin', 'Email/password sign-in is not enabled. Please use Google sign-in instead.');
        } else {
          showAuthError('signin', 'Sign in failed. Please check your credentials and try again.');
        }
        
        // Still show toast for non-mobile users
        showToast('error', 'Sign in error', error.message);
      }
    };

    // Sign up
    window.signUp = async function() {
      const name = document.getElementById('signup-name').value;
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      
      // Clear previous error messages
      clearAuthErrors();
      
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, 'users', userCredential.user.uid), {
          displayName: name,
          email: email,
          cityPreference: currentCity,
          createdAt: new Date()
        });
        closeAuthModal();
        showToast('success', 'Account created', `Welcome ${name}! Your account has been created successfully. 🎉`);
      } catch (error) {
        console.log('Sign up error:', error.code, error.message);
        
        if (error.code === 'auth/email-already-in-use') {
          showAuthError('signup', 'Email already registered. Please sign in instead or use a different email address.');
        } else if (error.code === 'auth/invalid-email') {
          showAuthError('signup', 'Invalid email format. Please enter a valid email address.');
        } else if (error.code === 'auth/weak-password') {
          showAuthError('signup', 'Password is too weak. Please use at least 6 characters.');
        } else if (error.code === 'auth/too-many-requests') {
          showAuthError('signup', 'Too many failed attempts. Please wait a few minutes before trying again.');
        } else if (error.code === 'auth/network-request-failed') {
          showAuthError('signup', 'Network error. Please check your internet connection and try again.');
        } else if (error.code === 'auth/operation-not-allowed') {
          showAuthError('signup', 'Email/password sign-up is not enabled. Please use Google sign-in instead.');
        } else {
          showAuthError('signup', 'Registration failed. Please check your information and try again.');
        }
        
        // Still show toast for non-mobile users
        showToast('error', 'Registration error', error.message);
      }
    };

    // Sign in with Google
    window.signInWithGoogle = async function() {
      const provider = new GoogleAuthProvider();
      try {
        console.log('🔐 Attempting Google sign in...');
        console.log('Firebase config:', firebaseConfig);
        console.log('Auth instance:', auth);
        
        const result = await signInWithPopup(auth, provider);
        console.log('✅ Google sign in successful:', result);
        
        if (result._tokenResponse?.isNewUser) {
          await setDoc(doc(db, 'users', result.user.uid), {
            displayName: result.user.displayName,
            email: result.user.email,
            cityPreference: currentCity,
            createdAt: new Date()
          });
        }
        closeAuthModal();
        showToast('success', 'Google sign in successful', 'Welcome to RoomRadar! 🏠');
      } catch (error) {
        console.error('❌ Google sign in error:', error);
        console.error('Error code:', error.code);
        console.error('Error message:', error.message);
        showToast('error', 'Google sign in error', error.message);
      }
    };

        // Toggle user dropdown - REMOVED: Now handled by modular navbar
    // window.toggleUserDropdown = function() { ... } - REMOVED

    // Sign out
    async function signOutUser() {
      try {
        console.log('🚪 Signing out user...');
        
        await signOut(auth);
        console.log('✅ Sign out successful');
        
        // Show success message if showToast is available
        if (typeof showToast === 'function') {
        showToast('success', 'Sign out successful', 'Goodbye! 👋');
        }
        
        // Redirect to homepage
        window.location.href = '/';
      } catch (error) {
        console.error('❌ Sign out error:', error);
        
        // Show error message if showToast is available
        if (typeof showToast === 'function') {
        showToast('error', 'Sign out error', error.message);
        }
        
        // Redirect to homepage anyway
        window.location.href = '/';
      }
    }
    
    // Make signOutUser globally available
    window.signOutUser = signOutUser;
    
    // Mobile menu functions
    window.toggleMobileMenu = function() {
      const mobileMenu = document.getElementById('mobile-menu');
      if (mobileMenu) {
        mobileMenu.classList.toggle('show');
      }
    };
    
    // Update navbar auth button - REMOVED: Now handled by modular navbar
    // function updateNavbarAuth() { ... } - REMOVED

    // Auth button is now in navbar - no need for header button
    window.showAuthButton = function() {
      // This function is kept for compatibility but auth is now handled by modular navbar
      console.log('🔄 Auth button update requested - handled by modular navbar');
    };

    // Check user status and show appropriate content
    window.checkUserStatus = function() {
      console.log('🔍 Checking user status...');
      console.log('Current user:', currentUser);
      
      if (currentUser) {
        // User is logged in - show full access
        console.log('✅ User is authenticated, showing full access');
        showFullAccess();
        // Re-render listings to show all of them
        if (typeof renderListings === 'function') {
          console.log('🔄 Re-rendering listings for authenticated user');
          renderListings();
        }
        // Update pagination for full access
        if (typeof updatePagination === 'function') {
          console.log('🔄 Updating pagination for authenticated user');
          updatePagination();
        }
      } else {
        // User is not logged in - show limited access
        console.log('🔒 User is not authenticated, showing limited access');
        showLimitedAccess();
        // Re-render listings with limited access
        if (typeof renderListings === 'function') {
          console.log('🔄 Re-rendering listings for non-authenticated user');
          renderListings();
        }
        // Update pagination for limited access
        if (typeof updatePagination === 'function') {
          console.log('🔄 Updating pagination for non-authenticated user');
          updatePagination();
        }
      }
    };

    // Show full access for registered users
    window.showFullAccess = function() {
      // Remove any limited access overlays
      const overlays = document.querySelectorAll('.limited-access-overlay');
      overlays.forEach(overlay => overlay.remove());
      
      // Remove the signup card if it exists
      const signupCard = document.querySelector('.card-content[style*="text-align: center"]');
      if (signupCard) {
        signupCard.closest('.card').remove();
      }
      
      // Remove limited access message
      const limitedMessage = document.querySelector('.limited-access-message');
      if (limitedMessage) {
        limitedMessage.remove();
      }
      
      // Show all listings without restrictions
      console.log('✅ Full access granted for registered user');
    };

    // Show limited access for non-registered users
    window.showLimitedAccess = function() {
      // Remove any existing overlays
      const overlays = document.querySelectorAll('.limited-access-overlay');
      overlays.forEach(overlay => overlay.remove());
      
      console.log('🔒 Limited access for non-registered user');
    };

    // Update auth state and check user status
    function updateAuthUI() {
      // This function is now handled by the modular navbar system
      // The navbar will automatically show the correct UI based on auth state
      console.log('🔄 Auth UI update requested - handled by modular navbar');
      
      // Directly call navbar functions based on current user
      if (currentUser) {
        console.log('✅ User is logged in, showing profile icon in navbar');
        if (typeof showProfileIcon === 'function') {
          showProfileIcon();
          }
        } else {
        console.log('❌ User is not logged in, showing sign in button in navbar');
        if (typeof showSignInButton === 'function') {
          showSignInButton();
        }
      }
      
      // Update listings and pagination based on auth state
      if (typeof checkUserStatus === 'function') {
        console.log('🔄 Updating listings and pagination...');
        setTimeout(() => {
      checkUserStatus();
        }, 100);
      }
    }

    // Make functions globally available
    window.showAuthButton = showAuthButton;
    window.showAuthModal = function(tab = 'signin') {
      // Create and show the auth modal with the specified tab
      const modal = document.createElement('div');
      modal.id = 'auth-modal';
      modal.innerHTML = `
        <div class="auth-modal-overlay">
          <div class="auth-modal">
            <div class="auth-modal-header">
              <h3>Welcome to RoomRadar</h3>
              <button onclick="closeAuthModal()" class="close-btn">×</button>
            </div>
            <div class="auth-modal-content">
              <div class="auth-tabs">
                <button class="auth-tab ${tab === 'signin' ? 'active' : ''}" onclick="switchAuthTab('signin')">Sign In</button>
                <button class="auth-tab ${tab === 'signup' ? 'active' : ''}" onclick="switchAuthTab('signup')">Sign Up</button>
              </div>
              
              <div id="signin-form" class="auth-form" style="display: ${tab === 'signin' ? 'flex' : 'none'};">
                <button onclick="signInWithGoogle()" class="auth-btn google-btn primary-google-btn">
                  <svg viewBox="0 0 24 24" style="width: 18px; height: 18px;">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                  </svg>
                  Sign in with Google
                </button>
                
                <div class="divider">
                  <span>or</span>
                </div>
                
                <div id="signin-email-form" class="email-form" style="display: none;">
                  <input type="email" id="signin-email" placeholder="Email" />
                  <input type="password" id="signin-password" placeholder="Password" />
                  <button onclick="signIn()" class="auth-btn">Sign In with Email</button>
                </div>
                
                <button onclick="toggleEmailForm('signin')" class="auth-btn secondary-btn" id="signin-email-toggle">
                  Sign in with Email
                </button>
              </div>
              
              <div id="signup-form" class="auth-form" style="display: ${tab === 'signup' ? 'flex' : 'none'};">
                <button onclick="signInWithGoogle()" class="auth-btn google-btn primary-google-btn">
                  <svg viewBox="0 0 24 24" style="width: 18px; height: 18px;">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                  </svg>
                  Sign up with Google
                </button>
                
                <div class="divider">
                  <span>or</span>
                </div>
                
                <div id="signup-email-form" class="email-form" style="display: none;">
                  <input type="text" id="signup-name" placeholder="Full Name" />
                  <input type="email" id="signup-email" placeholder="Email" />
                  <input type="password" id="signup-password" placeholder="Password" />
                  <button onclick="signUp()" class="auth-btn">Sign Up with Email</button>
                </div>
                
                <button onclick="toggleEmailForm('signup')" class="auth-btn secondary-btn" id="signup-email-toggle">
                  Sign up with Email
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Add styles
      const style = document.createElement('style');
      style.textContent = `
        .auth-modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
        }
        .auth-modal {
          background: white;
          border-radius: 16px;
          padding: 2rem;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .auth-modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1.5rem;
        }
        .close-btn {
          background: none;
          border: none;
          font-size: 1.5rem;
          cursor: pointer;
          color: #6b7280;
        }
        .auth-tabs {
          display: flex;
          margin-bottom: 1.5rem;
          border-bottom: 1px solid #e5e7eb;
        }
        .auth-tab {
          flex: 1;
          padding: 0.75rem;
          border: none;
          background: none;
          cursor: pointer;
          font-weight: 500;
          color: #6b7280;
          border-bottom: 2px solid transparent;
        }
        .auth-tab.active {
          color: #3B82F6;
          border-bottom-color: #3B82F6;
        }
        .auth-form {
          display: flex;
          flex-direction: column;
          gap: 1rem;
        }
        .auth-form input {
          padding: 0.75rem;
          border: 1px solid #e5e7eb;
          border-radius: 8px;
          font-size: 0.9rem;
          background-color: #ffffff;
          color: #374151;
        }
        .auth-btn {
          padding: 0.75rem;
          border: none;
          border-radius: 8px;
          background: #3B82F6;
          color: white;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 0.5rem;
        }
        .google-btn {
          background: white;
          color: #374151;
          border: 1px solid #e5e7eb;
        }
        .primary-google-btn {
          background: white;
          color: #374151;
          border: 1px solid #e5e7eb;
          font-weight: 600;
          font-size: 1rem;
          padding: 0.875rem;
        }
        .secondary-btn {
          background: #f8fafc;
          color: #64748b;
          border: 1px solid #e2e8f0;
          font-weight: 500;
        }
        .secondary-btn:hover {
          background: #f1f5f9;
          color: #475569;
        }
        .divider {
          display: flex;
          align-items: center;
          text-align: center;
          margin: 1rem 0;
          color: #9ca3af;
          font-size: 0.875rem;
        }
        .divider::before,
        .divider::after {
          content: '';
          flex: 1;
          border-bottom: 1px solid #e5e7eb;
        }
        .divider span {
          padding: 0 1rem;
          background: white;
        }
        .email-form {
          display: flex;
          flex-direction: column;
          gap: 1rem;
        }
      `;
      document.head.appendChild(style);
      document.body.appendChild(modal);
    };
    window.closeAuthModal = closeAuthModal;

    window.signIn = signIn;
    window.signUp = signUp;
    window.signInWithGoogle = signInWithGoogle;
    window.checkUserStatus = checkUserStatus;
    window.showFullAccess = showFullAccess;
    window.showLimitedAccess = showLimitedAccess;

    // Signal that Firebase is ready
    window.firebaseReady = true;

    // Inline authentication functions
    window.signInInline = async function() {
      const email = document.getElementById('signin-email-inline').value;
      const password = document.getElementById('signin-password-inline').value;
      
      // Clear previous error messages
      clearAuthErrorsInline();
      
      try {
        await signInWithEmailAndPassword(auth, email, password);
        // The onAuthStateChanged listener will handle UI updates
        console.log('✅ Sign in successful, UI will update automatically');
        showToast('success', 'Sign in successful', 'Welcome to RoomRadar! 🏠');
      } catch (error) {
        console.log('Sign in inline error:', error.code, error.message);
        
        // Check if user doesn't exist and auto-switch to signup
        if (error.code === 'auth/user-not-found') {
          // Switch to signup tab and pre-fill email
          switchAuthTab('signup');
          document.getElementById('signup-email-inline').value = email;
          document.getElementById('signup-name-inline').focus();
          showAuthErrorInline('signup', 'Account not found. We\'ve switched you to sign up with this email address.');
        } else if (error.code === 'auth/wrong-password') {
          showAuthErrorInline('signin', 'Incorrect password. Please check your password and try again.');
        } else if (error.code === 'auth/invalid-email') {
          showAuthErrorInline('signin', 'Invalid email format. Please enter a valid email address.');
        } else if (error.code === 'auth/too-many-requests') {
          showAuthErrorInline('signin', 'Too many failed attempts. Please wait a few minutes before trying again.');
        } else if (error.code === 'auth/user-disabled') {
          showAuthErrorInline('signin', 'This account has been disabled. Please contact support for assistance.');
        } else if (error.code === 'auth/network-request-failed') {
          showAuthErrorInline('signin', 'Network error. Please check your internet connection and try again.');
        } else if (error.code === 'auth/operation-not-allowed') {
          showAuthErrorInline('signin', 'Email/password sign-in is not enabled. Please use Google sign-in instead.');
        } else {
          showAuthErrorInline('signin', 'Sign in failed. Please check your credentials and try again.');
        }
        
        // Still show toast for non-mobile users
        showToast('error', 'Sign in error', error.message);
      }
    };

    window.signUpInline = async function() {
      const name = document.getElementById('signup-name-inline').value;
      const email = document.getElementById('signup-email-inline').value;
      const password = document.getElementById('signup-password-inline').value;
      
      // Clear previous error messages
      clearAuthErrorsInline();
      
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, 'users', userCredential.user.uid), {
          displayName: name,
          email: email,
          cityPreference: currentCity,
          createdAt: new Date()
        });
        // The onAuthStateChanged listener will handle UI updates
        console.log('✅ Sign up successful, UI will update automatically');
        showToast('success', 'Account created', `Welcome ${name}! Your account has been created successfully. 🎉`);
      } catch (error) {
        console.log('Sign up inline error:', error.code, error.message);
        
        if (error.code === 'auth/email-already-in-use') {
          showAuthErrorInline('signup', 'Email already registered. Please sign in instead or use a different email address.');
        } else if (error.code === 'auth/invalid-email') {
          showAuthErrorInline('signup', 'Invalid email format. Please enter a valid email address.');
        } else if (error.code === 'auth/weak-password') {
          showAuthErrorInline('signup', 'Password is too weak. Please use at least 6 characters.');
        } else if (error.code === 'auth/too-many-requests') {
          showAuthErrorInline('signup', 'Too many failed attempts. Please wait a few minutes before trying again.');
        } else if (error.code === 'auth/network-request-failed') {
          showAuthErrorInline('signup', 'Network error. Please check your internet connection and try again.');
        } else if (error.code === 'auth/operation-not-allowed') {
          showAuthErrorInline('signup', 'Email/password sign-up is not enabled. Please use Google sign-in instead.');
        } else {
          showAuthErrorInline('signup', 'Registration failed. Please check your information and try again.');
        }
        
        // Still show toast for non-mobile users
        showToast('error', 'Registration error', error.message);
      }
    };

    window.signInWithGoogleInline = async function() {
      const provider = new GoogleAuthProvider();
      try {
        const result = await signInWithPopup(auth, provider);
        if (result._tokenResponse?.isNewUser) {
          await setDoc(doc(db, 'users', result.user.uid), {
            displayName: result.user.displayName,
            email: result.user.email,
            cityPreference: currentCity,
            createdAt: new Date()
          });
        }
        // The onAuthStateChanged listener will handle UI updates
        console.log('✅ Google sign in successful, UI will update automatically');
        showToast('success', 'Google sign in successful', 'Welcome to RoomRadar! 🏠');
      } catch (error) {
        showToast('error', 'Google sign in error', error.message);
      }
    };

    // Helper functions for auth error messages
    function showAuthError(formType, message) {
      const formId = formType === 'signin' ? 'signin-form' : 'signup-form';
      const form = document.getElementById(formId);
      
      // Remove existing error message
      const existingError = form.querySelector('.auth-error-message');
      if (existingError) {
        existingError.remove();
      }
      
      // Create error message element
      const errorDiv = document.createElement('div');
      errorDiv.className = 'auth-error-message';
      errorDiv.style.cssText = `
        color: #dc2626;
        font-size: 0.875rem;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background-color: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 6px;
        text-align: center;
      `;
      errorDiv.textContent = message;
      
      // Insert error message at the end of the form
      form.appendChild(errorDiv);
    }

    function showAuthErrorInline(formType, message) {
      const formId = formType === 'signin' ? 'signin-form-inline' : 'signup-form-inline';
      const form = document.getElementById(formId);
      
      // Remove existing error message
      const existingError = form.querySelector('.auth-error-message');
      if (existingError) {
        existingError.remove();
      }
      
      // Create error message element
      const errorDiv = document.createElement('div');
      errorDiv.className = 'auth-error-message';
      errorDiv.style.cssText = `
        color: #dc2626;
        font-size: 0.875rem;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background-color: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 6px;
        text-align: center;
      `;
      errorDiv.textContent = message;
      
      // Insert error message at the end of the form
      form.appendChild(errorDiv);
    }

    function clearAuthErrors() {
      const signinForm = document.getElementById('signin-form');
      const signupForm = document.getElementById('signup-form');
      
      if (signinForm) {
        const error = signinForm.querySelector('.auth-error-message');
        if (error) error.remove();
      }
      
      if (signupForm) {
        const error = signupForm.querySelector('.auth-error-message');
        if (error) error.remove();
      }
    }

    function clearAuthErrorsInline() {
      const signinForm = document.getElementById('signin-form-inline');
      const signupForm = document.getElementById('signup-form-inline');
      
      if (signinForm) {
        const error = signinForm.querySelector('.auth-error-message');
        if (error) error.remove();
      }
      
      if (signupForm) {
        const error = signupForm.querySelector('.auth-error-message');
        if (error) error.remove();
      }
    }

    // Enhanced switchAuthTab for both modal and inline forms
    window.switchAuthTab = function(tab) {
      // Clear error messages when switching tabs
      clearAuthErrors();
      clearAuthErrorsInline();
      
      // Handle both modal and inline forms
      const modalSigninForm = document.getElementById('signin-form');
      const modalSignupForm = document.getElementById('signup-form');
      const inlineSigninForm = document.getElementById('signin-form-inline');
      const inlineSignupForm = document.getElementById('signup-form-inline');
      
      // Update modal forms
      if (modalSigninForm && modalSignupForm) {
        modalSigninForm.style.display = tab === 'signin' ? 'flex' : 'none';
        modalSignupForm.style.display = tab === 'signup' ? 'flex' : 'none';
      }
      
      // Update inline forms
      if (inlineSigninForm && inlineSignupForm) {
        inlineSigninForm.style.display = tab === 'signin' ? 'flex' : 'none';
        inlineSignupForm.style.display = tab === 'signup' ? 'flex' : 'none';
      }
      
      // Reset email forms when switching tabs
      resetEmailForms();
      resetEmailFormsInline();
      
      // Update tab styles - handle both modal and signup card tabs
      document.querySelectorAll('.auth-tab').forEach(t => {
        const isActive = t.textContent.toLowerCase().includes(tab);
        t.classList.toggle('active', isActive);
        
        // Apply specific styles for signup card tabs
        if (t.closest('.signup-card')) {
          if (isActive) {
            t.style.background = '#3B82F6';
            t.style.color = 'white';
            t.style.boxShadow = '0 1px 3px rgba(59, 130, 246, 0.2)';
        } else {
            t.style.background = 'transparent';
            t.style.color = '#6b7280';
            t.style.boxShadow = 'none';
          }
        }
      });
    };
  </script>
  
  <script>
    let allListings = [];
    let filteredListings = [];
    let currentPage = 1;
    let itemsPerPage = 20;
    let currentCity = 'barcelona'; // Default city
    let userFingerprint = null;

    // City display names mapping
    const cityNames = {
      barcelona: "Barcelona",
      roma: "Rome",
      london: "London"
    };

    // Force refresh to avoid cache
    if (performance.navigation.type === 1) {
      console.log("Page reloaded - clearing cache");
    }

    // Event listeners - defined before loadListings
    function setupEventListeners() {
      try {
        document.getElementById('filter-zone').addEventListener('change', applyFilters);
        document.getElementById('filter-reliability').addEventListener('change', applyFilters);
        document.getElementById('filter-price').addEventListener('input', applyFilters);
        document.getElementById('filter-date').addEventListener('change', applyFilters);
        document.getElementById('sort-by').addEventListener('change', applySorting);
        document.getElementById('items-per-page').addEventListener('change', changeItemsPerPage);
        console.log("✅ Event listeners configured");
      } catch (error) {
        console.error("❌ Error configuring event listeners:", error);
      }
    }

    // Funzione per generare fingerprint utente
    function generateUserFingerprint() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.textBaseline = 'top';
      ctx.font = '14px Arial';
      ctx.fillText('User fingerprint', 2, 2);
      
      const fingerprint = [
        navigator.userAgent,
        navigator.language,
        screen.width + 'x' + screen.height,
        new Date().getTimezoneOffset(),
        navigator.hardwareConcurrency,
        navigator.deviceMemory,
        canvas.toDataURL()
      ].join('|');
      
      // Hash semplice del fingerprint
      let hash = 0;
      for (let i = 0; i < fingerprint.length; i++) {
        const char = fingerprint.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
      }
      return Math.abs(hash).toString(36);
    }

    // Funzione per ottenere la città corrente dall'URL o localStorage
    function getCurrentCity() {
      const urlParams = new URLSearchParams(window.location.search);
      const cityFromUrl = urlParams.get('city');
      
      if (cityFromUrl && ['barcelona', 'roma', 'london'].includes(cityFromUrl)) {
        localStorage.setItem('selectedCity', cityFromUrl);
        return cityFromUrl;
      }
      
      // Prova localStorage
      const savedCity = localStorage.getItem('selectedCity');
      if (savedCity && ['barcelona', 'roma', 'london'].includes(savedCity)) {
        return savedCity;
      }
      
      return 'barcelona';
    }

    // Funzione per salvare la preferenza città dell'utente
    function saveUserCityPreference(city) {
      // Salva in localStorage
      localStorage.setItem('selectedCity', city);
      
      // Salva con fingerprint per persistenza cross-device
      if (userFingerprint) {
        const userPreferences = JSON.parse(localStorage.getItem('userPreferences') || '{}');
        userPreferences[userFingerprint] = {
          city: city,
          lastVisit: new Date().toISOString()
        };
        localStorage.setItem('userPreferences', JSON.stringify(userPreferences));
      }
      
      // Marca che l'utente ha visitato prima
      localStorage.setItem('hasVisitedBefore', 'true');
    }

    // Funzione per controllare se l'utente ha già una preferenza salvata
    function hasUserPreference() {
      const savedCity = localStorage.getItem('selectedCity');
      return savedCity && ['barcelona', 'roma', 'london'].includes(savedCity);
    }

    // Funzione per inizializzare la UI in base al tipo di utente
    function initializeUserInterface() {
      const hasPreference = hasUserPreference();
      
      // Controlli di sicurezza per tutti gli elementi
      const citySearchContainer = document.getElementById('city-search-container');
      const currentCityDisplayContainer = document.getElementById('current-city-display-container');
      const currentCityText = document.getElementById('current-city-text');
      const listings = document.getElementById('listings');
      const filters = document.getElementById('filters');
      const pagination = document.getElementById('pagination');
      
      if (hasPreference) {
        // Utente con preferenza: mostra direttamente i listings
        const savedCity = localStorage.getItem('selectedCity');
        currentCity = savedCity;
        
        // Nascondi la barra di ricerca e il testo di aiuto
        if (citySearchContainer) citySearchContainer.style.display = 'none';
        
        // Nascondi anche il testo di aiuto se esiste
        const helpText = document.querySelector('.city-search-container + div');
        if (helpText) helpText.style.display = 'none';
        
        // Mostra il display della città corrente
        if (currentCityDisplayContainer) currentCityDisplayContainer.style.display = 'flex';
        if (currentCityText) currentCityText.textContent = getCityDisplayName(savedCity);
        
        // Aggiorna l'URL
        const url = new URL(window.location);
        url.searchParams.set('city', savedCity);
        window.history.pushState({}, '', url);
        
        // Mostra i listings e i filtri
        if (listings) listings.style.display = 'block';
        if (filters) filters.style.display = 'block';
        if (pagination) pagination.style.display = 'block';
        
        console.log(`👋 Welcome back! Loading ${savedCity} listings...`);
      } else {
        // Nuovo utente: mostra la barra di ricerca
        if (citySearchContainer) citySearchContainer.style.display = 'flex';
        if (currentCityDisplayContainer) currentCityDisplayContainer.style.display = 'none';
        
        // Nascondi i listings finché non viene selezionata una città
        if (listings) listings.style.display = 'none';
        if (filters) filters.style.display = 'none';
        if (pagination) pagination.style.display = 'none';
        
        console.log('👋 New user! Please select a city to start.');
      }
    }

    // Funzione per gestire il cambio di selezione città
    function handleCitySelection() {
      const citySelect = document.getElementById('city-select');
      const searchBtn = document.getElementById('search-btn');
      
      if (citySelect && searchBtn) {
        citySelect.addEventListener('change', function() {
          const selectedCity = this.value;
          console.log('🔄 City selection changed to:', selectedCity);
          
          if (selectedCity) {
            // Abilita il pulsante di ricerca
            searchBtn.style.opacity = '1';
            searchBtn.style.pointerEvents = 'auto';
            searchBtn.style.animation = 'pulse-glow 2s ease-in-out infinite';
            searchBtn.style.cursor = 'pointer';
            console.log('🔍 Search button enabled for:', selectedCity);
            
            // Carica immediatamente gli annunci per la città selezionata (senza scroll)
            console.log('🔄 Auto-loading listings for:', selectedCity);
            loadListingsForCity(selectedCity, false); // No scroll
            
          } else {
            // Disabilita il pulsante di ricerca
            searchBtn.style.opacity = '0.6';
            searchBtn.style.pointerEvents = 'none';
            searchBtn.style.animation = 'none';
            searchBtn.style.cursor = 'not-allowed';
            console.log('🔍 Search button disabled');
          }
        });
        
        console.log('✅ City selection event listeners configured');
      } else {
        console.error('❌ City select elements not found');
      }
    }

    // Funzione per ottenere la preferenza città dell'utente dal fingerprint
    function getUserCityPreference() {
      if (!userFingerprint) return null;
      
      const userPreferences = JSON.parse(localStorage.getItem('userPreferences') || '{}');
      const userPref = userPreferences[userFingerprint];
      
      if (userPref && userPref.city && ['barcelona', 'roma', 'london'].includes(userPref.city)) {
        return userPref.city;
      }
      
      return null;
    }

    // Funzione per aggiornare il titolo della città
    function updateCityTitle() {
      const cityNames = {
        'barcelona': 'Barcelona',
        'roma': 'Rome',
        'london': 'London'
      };
      
      // Aggiorna il display della città nel pulsante
      const cityDisplay = document.getElementById('current-city-display');
      if (cityDisplay) {
        cityDisplay.textContent = cityNames[currentCity];
      }
    }



    // Cache per i dati delle città
    const cityDataCache = {};
    
    async function loadListings() {
      try {
        console.log("=== STARTING DATA LOADING ===");
        console.log("Timestamp:", new Date().toISOString());
        
        // Determina la città corrente
        currentCity = getCurrentCity();
        updateCityTitle();
        
        console.log(`🏙️ Loading data for city: ${currentCity}`);
        
        // Controlla se abbiamo i dati in cache
        if (cityDataCache[currentCity] && (Date.now() - cityDataCache[currentCity].timestamp) < 30000) { // 30 secondi cache
          console.log(`📦 Using cached data for ${currentCity}`);
          const cachedData = cityDataCache[currentCity].data;
          allListings = cachedData.results || [];
          window.totalRejectedCount = cachedData.totalRejectedCount || 0;
          
          document.getElementById('loading').style.display = 'none';
          setupEventListeners();
          populateFilters();
          applyFilters();
          updateStats();
          console.log(`✅ City switch completed for ${currentCity} (from cache)`);
          return;
        }
        
        // Add timestamp to avoid cache
        const response = await fetch(`public/data_${currentCity}.json?t=${Date.now()}`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log("=== DATA RECEIVED ===");
        console.log("Data type:", typeof data);
        console.log("Is it an array?", Array.isArray(data));
        console.log("Has 'results' property?", data.hasOwnProperty('results'));
        console.log("Object properties:", Object.keys(data));
        
        // Carica il contatore dei post scartati
        window.totalRejectedCount = data.totalRejectedCount || 0;
        console.log(`📊 Total rejected posts by AI: ${window.totalRejectedCount}`);
        
        // Check data structure
        if (data.results && Array.isArray(data.results)) {
          allListings = data.results;
          console.log(`Loaded ${allListings.length} listings from data.results`);
        } else if (Array.isArray(data)) {
          allListings = data;
          console.log(`Loaded ${allListings.length} listings from direct array`);
        } else {
          console.log("Unexpected data structure:", data);
          allListings = [];
        }
        
        // Gestione file vuoti o senza risultati
        if (allListings.length === 0) {
          console.log(`⚠️ No listings found for ${currentCity}. This might be normal if no new posts were found.`);
        }
        
        // Salva in cache per future chiamate
        cityDataCache[currentCity] = {
          data: data,
          timestamp: Date.now()
        };
        console.log(`💾 Cached data for ${currentCity}`);

        console.log("=== LISTING DETAILS ===");
        console.log("First 3 listings:", allListings.slice(0, 3));
        console.log("Last 3 listings:", allListings.slice(-3));
        
        if (allListings.length > 0) {
          console.log("Example listing:", allListings[0]);
          console.log("Available properties:", Object.keys(allListings[0]));
        }

        document.getElementById('loading').style.display = 'none';
        setupEventListeners(); // Configure event listeners after loading
        populateFilters();
        applyFilters(); // This will call updateStats() at the end
        
        // Ensure stats are always shown
        setTimeout(() => {
          if (typeof updateStats === 'function') {
            updateStats();
          }
          
          // Update the active listings count in the city display
          updateActiveListingsCount();
        }, 100);
        
        // Check user status after data is loaded (wait for Firebase)
        function waitForFirebaseAndCheckStatus() {
          if (window.firebaseReady && window.checkUserStatus) {
            window.checkUserStatus();
          } else {
            setTimeout(waitForFirebaseAndCheckStatus, 50);
          }
        }
        waitForFirebaseAndCheckStatus();
        

        
        console.log(`✅ City switch completed for ${currentCity}`);
      } catch (error) {
        console.error("=== LOADING ERROR ===", error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('listings').innerHTML = `
          <div class="error">
            <h3>🚫 Loading Error</h3>
            <p>${error.message}</p>
            <p style="margin-top: 1rem; font-size: 0.875rem;">
              Please verify that the file <code>public/data.json</code> exists and is accessible.
            </p>
          </div>
        `;
      }
    }

    function updateStats() {
      const statsDiv = document.getElementById('stats');
      if (allListings.length > 0) {
        // Count active posts (not expired and not verification_needed)
        const activeListings = allListings.filter(l => l.status !== "expired" && l.status !== "verification_needed");
        const total = activeListings.length;
        const filtered = filteredListings.length;
        const hasActiveFilters = hasFilters();
        
        const now = new Date();
        const timeStr = now.toLocaleTimeString('it-IT', {
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const filterText = hasActiveFilters ? `${filtered} listings match your criteria` : `${total} active listings available`;
        
        // Mostra il contatore dei post scartati se disponibile
        const rejectedCountHtml = window.totalRejectedCount > 0 ? `
          <span style="color: #6b7280;">•</span>
          <span style="display: flex; align-items: center; gap: 0.5rem;">
            <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; color: #ef4444;">
              <path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z"></path>
            </svg>
            <strong>${window.totalRejectedCount.toLocaleString()}</strong> posts rejected by AI
          </span>
        ` : '';
        
        statsDiv.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; flex-wrap: wrap;">
            <span style="display: flex; align-items: center; gap: 0.5rem;">
              <svg class="icon" viewBox="0 0 24 24" style="width: 18px; height: 18px; color: #10B981;">
                <path d="M9 12l2 2 4-4"></path>
                <circle cx="12" cy="12" r="10"></circle>
              </svg>
              <strong>${filterText}</strong>
            </span>
            <span style="color: #6b7280;">•</span>
            <span style="display: flex; align-items: center; gap: 0.5rem;">
              <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; color: #6b7280;">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12,6 12,12 16,14"></polyline>
              </svg>
              Updated at <strong>${timeStr}</strong>
            </span>
            ${rejectedCountHtml}
          </div>
        `;
        statsDiv.style.display = 'block';
      }
    }

    function hasFilters() {
      const zone = document.getElementById('filter-zone').value;
      const minReliability = document.getElementById('filter-reliability').value;
      const maxPrice = document.getElementById('filter-price').value;
      const dateFilter = document.getElementById('filter-date').value;
      
      return zone || minReliability || maxPrice || dateFilter;
    }

    function updateActiveFilters() {
      const activeFiltersDiv = document.getElementById('active-filters');
      const filterTagsDiv = document.getElementById('filter-tags');
      
      const filters = [];
      
      const zone = document.getElementById('filter-zone').value;
      if (zone) filters.push({ type: 'Zone', value: zone, id: 'zone' });
      
      const minReliability = document.getElementById('filter-reliability').value;
      if (minReliability) filters.push({ type: 'Min. Reliability', value: `≥ ${minReliability}`, id: 'reliability' });
      
      const maxPrice = document.getElementById('filter-price').value;
      if (maxPrice) filters.push({ type: 'Max Price', value: `€${maxPrice}`, id: 'price' });
      
      const dateFilter = document.getElementById('filter-date').value;
      if (dateFilter) {
        let dateText = '';
        switch (dateFilter) {
          case '1': dateText = 'Today'; break;
          case '3': dateText = 'Last 3 days'; break;
          case '7': dateText = 'Last week'; break;
          case '30': dateText = 'Last month'; break;
        }
        filters.push({ type: 'Date', value: dateText, id: 'date' });
      }
      
      if (filters.length > 0) {
        filterTagsDiv.innerHTML = filters.map(filter => `
          <span class="filter-tag">
            ${filter.type}: ${filter.value}
            <button class="remove-filter" onclick="removeFilter('${filter.id}')" title="Remove filter">×</button>
          </span>
        `).join('');
        activeFiltersDiv.classList.add('show');
      } else {
        activeFiltersDiv.classList.remove('show');
      }
    }

    function removeFilter(filterId) {
      switch (filterId) {
        case 'zone':
          document.getElementById('filter-zone').value = '';
          break;
        case 'reliability':
          document.getElementById('filter-reliability').value = '';
          break;
        case 'price':
          document.getElementById('filter-price').value = '';
          break;
        case 'date':
          document.getElementById('filter-date').value = '';
          break;
      }
      applyFilters();
    }

    function clearAllFilters() {
      document.getElementById('filter-zone').value = '';
      document.getElementById('filter-reliability').value = '';
      document.getElementById('filter-price').value = '';
      document.getElementById('filter-date').value = '';
      applyFilters();
    }

    function populateFilters() {
      // Filter only active posts to populate filters
      const activeListings = allListings.filter(l => l.status !== "expired" && l.status !== "verification_needed");
      const zones = [...new Set(activeListings.map(l => l.zoneMacro || null).filter(Boolean))].sort();

      console.log("Available zones:", zones);

      const zoneSelect = document.getElementById('filter-zone');
      zoneSelect.innerHTML = '<option value="">All zones</option>';
      zones.forEach(z => zoneSelect.add(new Option(z, z)));
    }

    function applyFilters() {
      const zone = document.getElementById('filter-zone').value;
      const minReliability = parseInt(document.getElementById('filter-reliability').value) || 0;
      const maxPrice = parseInt(document.getElementById('filter-price').value) || Infinity;
      const dateFilter = document.getElementById('filter-date').value;

      console.log("=== APPLYING FILTERS ===");
      console.log("Active filters:", { zone, minReliability, maxPrice, dateFilter });

      filteredListings = allListings.filter(l => {
        // Exclude posts with status "expired"
        if (l.status === "expired" || l.status === "verification_needed") {
          return false;
        }
        
        const zoneMatch = !zone || l.zoneMacro === zone;
        const reliabilityMatch = (l.reliability || 0) >= minReliability;
        const priceMatch = (parseInt(l.price) || 0) <= maxPrice;
        
        // Date filter - use dateAdded if available, otherwise datePublished
        let dateMatch = true;
        if (dateFilter) {
          const postDate = l.dateAdded || l.datePublished;
          if (postDate) {
            const postDateObj = new Date(postDate);
            const now = new Date();
            
            // Normalize dates to compare only the date (without time)
            const postDateOnly = new Date(postDateObj.getFullYear(), postDateObj.getMonth(), postDateObj.getDate());
            const nowDateOnly = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch (dateFilter) {
              case '1': // Today
                dateMatch = postDateOnly.getTime() === nowDateOnly.getTime();
                break;
              case '3': // Last 3 days
                const threeDaysAgo = new Date(nowDateOnly);
                threeDaysAgo.setDate(nowDateOnly.getDate() - 2); // -2 because we include today
                dateMatch = postDateOnly >= threeDaysAgo && postDateOnly <= nowDateOnly;
                break;
              case '7': // Last week
                const sevenDaysAgo = new Date(nowDateOnly);
                sevenDaysAgo.setDate(nowDateOnly.getDate() - 6); // -6 because we include today
                dateMatch = postDateOnly >= sevenDaysAgo && postDateOnly <= nowDateOnly;
                break;
              case '30': // Last month
                const thirtyDaysAgo = new Date(nowDateOnly);
                thirtyDaysAgo.setDate(nowDateOnly.getDate() - 29); // -29 because we include today
                dateMatch = postDateOnly >= thirtyDaysAgo && postDateOnly <= nowDateOnly;
                break;
            }
          } else {
            // If there's no date, don't show for temporal filters
            dateMatch = false;
          }
        }
        
        return zoneMatch && reliabilityMatch && priceMatch && dateMatch;
      });

      console.log(`Filtered listings: ${filteredListings.length} out of ${allListings.length}`);
      currentPage = 1; // Reset to first page when applying filters
      applySorting();
      renderListings();
      updatePagination();
      updateActiveFilters();
      updateStats();
    }

    function applySorting() {
      const sortBy = document.getElementById('sort-by').value;
      
      console.log("=== APPLYING SORTING ===");
      console.log("Sort type:", sortBy);
      
      filteredListings.sort((a, b) => {
        switch (sortBy) {
          case 'date-desc':
            return new Date(b.dateAdded || 0) - new Date(a.dateAdded || 0);
          case 'date-asc':
            return new Date(a.dateAdded || 0) - new Date(b.dateAdded || 0);
          case 'rating-desc':
            return (b.reliability || 0) - (a.reliability || 0);
          case 'rating-asc':
            return (a.reliability || 0) - (b.reliability || 0);
          case 'price-asc':
            return (parseInt(a.price) || 0) - (parseInt(b.price) || 0);
          case 'price-desc':
            return (parseInt(b.price) || 0) - (parseInt(a.price) || 0);
          default:
            return 0;
        }
      });

      console.log("Sorting applied, first 3 elements:", filteredListings.slice(0, 3));
      
      // Reset to first page and update display
      currentPage = 1;
      renderListings();
      updatePagination();
    }

    // Function to process censored text and add tooltip spans
    function processCensoredText(text) {
      // Regex to match [PHONE NUMBER CENSORED], [... CENSORED] patterns
      const censoredPattern = /\[([^[\]]*\s*CENSORED)\]/gi;
      
      return text.replace(censoredPattern, (match, content) => {
        return `<span class="censored-text">${match}<div class="censored-tooltip">For more details, see the original post on Facebook</div></span>`;
      });
    }

    function renderListings() {
      const container = document.getElementById('listings');
      container.innerHTML = "";
      
      // Check if user is logged in
      const isLoggedIn = currentUser !== null;
      
      // Limit listings for non-registered users
      let listingsToShow = filteredListings;
      if (!isLoggedIn) {
        listingsToShow = filteredListings.slice(0, 15); // Show first 15 listings (14 + 1 signup card)
        console.log('🔒 Limited access: showing 15 listings for non-registered user');
      }
      
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageListings = listingsToShow.slice(startIndex, endIndex);
      
      console.log(`=== RENDERING PAGE ${currentPage} ===`);
      console.log(`Showing listings ${startIndex + 1}-${Math.min(endIndex, filteredListings.length)} of ${filteredListings.length}`);
      
      if (pageListings.length === 0) {
        container.innerHTML = `
          <div class="no-results">
            <div style="font-size: 4rem; margin-bottom: 1rem;">🏠</div>
            <h3 style="margin-bottom: 1rem; font-size: 1.5rem;">No rooms found</h3>
            <p>Try adjusting your search filters to see more results</p>
          </div>
        `;
        return;
      }

      // Add limited access message for non-registered users
      if (!isLoggedIn && filteredListings.length > 15) {
        const limitedMessage = document.createElement('div');
        limitedMessage.className = 'limited-access-message';
        limitedMessage.innerHTML = `
          <div style="
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
          ">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">🔒</div>
            <h4 style="color: #1f2937; margin-bottom: 0.5rem;">Limited Preview</h4>
            <p style="color: #6b7280; margin-bottom: 1rem;">
              Showing 15 of ${filteredListings.length} available rooms. 
              <strong style="color: #007AFF; font-weight: 600; letter-spacing: -0.025em;">Sign up for FREE</strong> to see all rooms and advanced features!
            </p>
            <button onclick="showAuthModal('signup')" class="btn btn-primary" style="font-size: 0.9rem;">
              <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                <polyline points="10,17 15,12 10,7"></polyline>
                <line x1="15" y1="12" x2="3" y2="12"></line>
              </svg>
              Sign Up FREE
            </button>
          </div>
        `;
        container.appendChild(limitedMessage);
      }

      pageListings.forEach((l, index) => {
        console.log(`Rendering listing ${startIndex + index + 1}:`, l.title || "No title");
        
        // Check if this should be the signup card (15th position for non-registered users)
        const shouldShowSignup = !isLoggedIn && (startIndex + index + 1) === 15;
        
        if (shouldShowSignup) {
          // Create signup card instead of listing
          const signupCard = document.createElement("div");
          signupCard.className = "card signup-card";
          signupCard.style.animationDelay = `${index * 0.1}s`;
          signupCard.innerHTML = `
            <div class="card-content" style="text-align: center; padding: 2rem;">
              <div style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1.5rem;">
                <div style="font-size: 2.5rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">🚀</div>
                <h3 style="color: #1f2937; font-size: 1.75rem; font-weight: 700; letter-spacing: -0.025em; margin: 0;">Unlock Full Access - FREE!</h3>
              </div>
              <p style="color: #6b7280; margin-bottom: 2rem; line-height: 1.7; font-size: 1.1rem;">
                <strong style="color: #007AFF; font-weight: 600; letter-spacing: -0.025em;">Join RoomRadar for FREE</strong> to see all ${filteredListings.length} available rooms and get access to advanced features like favorites, personalized recommendations, and more!
              </p>
              
              <div class="auth-tabs" style="display: flex; margin-bottom: 1.5rem; justify-content: center; background: transparent; border-radius: 8px; padding: 0.25rem; border: 1px solid #e5e7eb;">
                <button class="auth-tab" onclick="switchAuthTab('signin')" style="flex: 1; padding: 0.75rem; border: none; background: transparent; cursor: pointer; font-weight: 500; color: #6b7280; border-radius: 6px; max-width: 120px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">Sign In</button>
                <button class="auth-tab active" onclick="switchAuthTab('signup')" style="flex: 1; padding: 0.75rem; border: none; background: #3B82F6; cursor: pointer; font-weight: 600; color: white; border-radius: 6px; max-width: 120px; box-shadow: 0 1px 3px rgba(59, 130, 246, 0.2); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">Sign Up</button>
              </div>
              
              <div id="signin-form-inline" class="auth-form" style="display: none; flex-direction: column; gap: 1rem; max-width: 300px; margin: 0 auto;">
                <button onclick="signInWithGoogleInline()" class="btn google-btn primary-google-btn" style="padding: 0.875rem; border: 1px solid #e5e7eb; border-radius: 12px; background: white; color: #374151; font-weight: 600; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                  <svg viewBox="0 0 24 24" style="width: 18px; height: 18px;">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                  </svg>
                  Sign in with Google
                </button>
                
                <div class="divider" style="display: flex; align-items: center; text-align: center; margin: 1rem 0; color: #9ca3af; font-size: 0.875rem;">
                  <span style="flex: 1; border-bottom: 1px solid #e5e7eb;"></span>
                  <span style="padding: 0 1rem; background: transparent; font-weight: 500;">or</span>
                  <span style="flex: 1; border-bottom: 1px solid #e5e7eb;"></span>
                </div>
                
                <div id="signin-email-form-inline" class="email-form" style="display: none; flex-direction: column; gap: 1rem;">
                  <input type="email" id="signin-email-inline" placeholder="Email" style="padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; background-color: #ffffff; color: #374151;" />
                  <input type="password" id="signin-password-inline" placeholder="Password" style="padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; background-color: #ffffff; color: #374151;" />
                <button onclick="signInInline()" class="btn btn-primary" style="padding: 0.75rem; border: none; border-radius: 8px; background: #3B82F6; color: white; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                  <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                    <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                    <polyline points="10,17 15,12 10,7"></polyline>
                    <line x1="15" y1="12" x2="3" y2="12"></line>
                  </svg>
                    Sign In with Email
                </button>
                </div>
                
                <button onclick="toggleEmailFormInline('signin')" class="btn secondary-btn" id="signin-email-toggle-inline" style="padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 12px; background: #f8fafc; color: #64748b; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">
                  Sign in with Email
                </button>
              </div>
              
              <div id="signup-form-inline" class="auth-form" style="display: flex; flex-direction: column; gap: 1rem; max-width: 300px; margin: 0 auto;">
                <button onclick="signInWithGoogleInline()" class="btn google-btn primary-google-btn" style="padding: 0.875rem; border: 1px solid #e5e7eb; border-radius: 12px; background: white; color: #374151; font-weight: 600; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                  <svg viewBox="0 0 24 24" style="width: 18px; height: 18px;">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                  </svg>
                  Sign up with Google
                </button>
                
                <div class="divider" style="display: flex; align-items: center; text-align: center; margin: 1rem 0; color: #9ca3af; font-size: 0.875rem;">
                  <span style="flex: 1; border-bottom: 1px solid #e5e7eb;"></span>
                  <span style="padding: 0 1rem; background: transparent; font-weight: 500;">or</span>
                  <span style="flex: 1; border-bottom: 1px solid #e5e7eb;"></span>
              </div>
              
                <div id="signup-email-form-inline" class="email-form" style="display: none; flex-direction: column; gap: 1rem;">
                  <input type="text" id="signup-name-inline" placeholder="Full Name" style="padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; background-color: #ffffff; color: #374151;" />
                  <input type="email" id="signup-email-inline" placeholder="Email" style="padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; background-color: #ffffff; color: #374151;" />
                  <input type="password" id="signup-password-inline" placeholder="Password" style="padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; background-color: #ffffff; color: #374151;" />
                <button onclick="signUpInline()" class="btn btn-primary" style="padding: 0.75rem; border: none; border-radius: 8px; background: #3B82F6; color: white; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                  <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                    <path d="M9 12l2 2 4-4"></path>
                    <circle cx="12" cy="12" r="10"></circle>
                  </svg>
                    Sign Up with Email
                </button>
                </div>
                
                <button onclick="toggleEmailFormInline('signup')" class="btn secondary-btn" id="signup-email-toggle-inline" style="padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 12px; background: #f8fafc; color: #64748b; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">
                  Sign up with Email
                </button>
              </div>
            </div>
          `;
          
          // Add styles for signup card
          const style = document.createElement('style');
          style.textContent = `
            .signup-card {
              background: linear-gradient(135deg, #f0f9ff, #e0f2fe) !important;
              border: 2px solid rgba(59, 130, 246, 0.3) !important;
              box-shadow: 0 8px 32px rgba(59, 130, 246, 0.2) !important;
              transform: scale(1.02) !important;
              transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            }
            .signup-card:hover {
              transform: scale(1.03) !important;
              box-shadow: 0 12px 40px rgba(59, 130, 246, 0.3) !important;
            }
            .signup-card .auth-tab.active {
              color: white !important;
              background: #3B82F6 !important;
              box-shadow: 0 1px 3px rgba(59, 130, 246, 0.2) !important;
            }
            .signup-card .auth-tab:hover {
              background: rgba(59, 130, 246, 0.1) !important;
              transform: translateY(-1px) !important;
            }
            .signup-card .btn.google-btn:hover {
              transform: translateY(-2px) !important;
              box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
              border-color: #d1d5db !important;
            }
            .signup-card .btn.secondary-btn:hover {
              transform: translateY(-1px) !important;
              background: #f1f5f9 !important;
              color: #475569 !important;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
            }
            .signup-card .btn.btn-primary:hover {
              transform: translateY(-1px) !important;
              box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3) !important;
            }
            .signup-card .auth-form input:focus {
              outline: none !important;
              border-color: #3B82F6 !important;
              box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
              transition: all 0.2s ease !important;
            }
          `;
          document.head.appendChild(style);
          
          container.appendChild(signupCard);
          return; // Skip the normal listing rendering
        }
        
        const div = document.createElement("div");
        div.className = "card";
        div.style.animationDelay = `${index * 0.1}s`;

        // Use "original_description" if available, otherwise "description", finally "overview"
        const description = l.original_description || l.description || l.overview || "";
        const processedDescription = processCensoredText(description);
        const shortText = description.length > 200 ? processCensoredText(description.slice(0, 200) + "...") : processedDescription;
        const isLong = description.length > 200;

        // Format date and time
        const formatDateTime = (dateString) => {
          if (!dateString) return "Date not available";
          try {
            const date = new Date(dateString);
            const dateStr = date.toLocaleDateString('en-US', {
              day: '2-digit',
              month: 'short',
              year: 'numeric'
            });
            const timeStr = date.toLocaleTimeString('en-US', {
              hour: '2-digit',
              minute: '2-digit'
            });
            return `${dateStr} at ${timeStr}`;
          } catch (e) {
            return dateString;
          }
        };

        const rating = parseInt(l.reliability || 0, 10);
        const ratingClass = rating >= 4 ? 'high' : (rating <= 2 ? 'low' : 'mid');

        // Create thumbnail (with image or house emoji only on desktop)
        const thumbnailHtml = l.imageUrl ? `
          <div class="card-thumbnail" onclick="window.open('${l.link}', '_blank')" onkeydown="if(event.key==='Enter'||event.key===' ')window.open('${l.link}', '_blank')" style="cursor: pointer;" role="button" tabindex="0" aria-label="Open listing: ${l.title || 'No title'}">
            <div class="card-thumbnail-loading">Loading...</div>
            <img src="${l.imageUrl}" alt="Listing image: ${l.title || 'No title'}" 
                 onerror="this.parentElement.innerHTML='<div class=\\'card-thumbnail-error\\' style=\\'color: #dc2626; font-size: 0.8rem; text-align: center; padding: 1rem;\\'>Image unavailable</div>'"
                 onload="this.style.opacity='1'; this.previousElementSibling.style.display='none';"
                 loading="lazy">
          </div>
        ` : `
          <div class="card-thumbnail card-thumbnail-desktop-only" onclick="window.open('${l.link}', '_blank')" onkeydown="if(event.key==='Enter'||event.key===' ')window.open('${l.link}', '_blank')" style="cursor: pointer;" role="button" tabindex="0" aria-label="Open listing: ${l.title || 'No title'}">
            <div class="card-thumbnail-placeholder">🏠</div>
          </div>
        `;

        div.innerHTML = `
          ${thumbnailHtml}
          <div class="card-content">
            <div class="card-header">
              <h3 class="card-title" onclick="window.open('${l.link}', '_blank')">${l.title || "Untitled"}</h3>
              <div class="card-rating ${ratingClass}">
                ${l.reliabilityReason ? `
                  <div class="rating-info" title="Reliability reason">
                    i
                    <div class="rating-tooltip"><strong>Rating reason:</strong> ${l.reliabilityReason}</div>
                  </div>
                ` : ''}
                ⭐ ${l.reliability || "N/A"}
              </div>
            </div>
            
            <div class="card-date">
              <svg class="date-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              Added: ${formatDateTime(l.dateAdded)}
            </div>
            
            <div class="card-meta">
              <span class="meta-tag price">
                ${l.price || "N/A"}
              </span>
              <span class="meta-tag zone">
                <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                  <circle cx="12" cy="10" r="3"></circle>
                </svg>
                ${l.zoneMacro || (l.zone || "Unknown area")}
              </span>
            </div>
            
            ${l.overview ? `
              <div class="card-overview-ai">
                <div class="overview-ai-header">
                  <svg class="overview-ai-icon" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z"></path>
                  </svg>
                  AI Summary
                </div>
                <div class="overview-ai-text">${l.overview}</div>
              </div>
            ` : ''}
            
            <div class="card-description">
              ${shortText}
              ${isLong ? `<span class="read-more-link">Read more</span>` : ''}
            </div>
            
                                        <div class="card-actions">
                <div class="left-actions">
                  <a href="${l.link}" target="_blank" class="btn btn-primary">
                    <svg class="icon" viewBox="0 0 24 24" style="width: 18px; height: 18px;">
                      <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                      <polyline points="15,3 21,3 21,9"></polyline>
                      <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    View on Facebook
                  </a>
                  <span class="report-btn" onclick="handleReportClick(window.auth, '${l.id || l.link}', '${encodeURIComponent(JSON.stringify(l))}')" style="display: ${window.auth && window.auth.currentUser ? 'inline' : 'none'};">
                    Report listing
                  </span>
                </div>
                          <svg class="favorite-btn" data-favorite-btn data-listing-id="${l.id || l.link}" data-tooltip="Add to favorites" onclick="handleFavoriteClick(window.auth, '${l.id || l.link}')" title="Add to favorites" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
          </svg>
              </div>
              <!-- Mobile Report Button - Only visible on mobile -->
              <span class="report-btn-mobile" onclick="handleReportClick(window.auth, '${l.id || l.link}', '${encodeURIComponent(JSON.stringify(l))}')" style="display: ${window.auth && window.auth.currentUser ? 'block' : 'none'};">
                Report listing
              </span>
          </div>
        `;

        container.appendChild(div);

        // Handle "Read more" functionality
        if (isLong) {
          const readMoreLink = div.querySelector(".read-more-link");
          const descriptionEl = div.querySelector(".card-description");
          
          if (readMoreLink && descriptionEl) {
            readMoreLink.addEventListener("click", () => {
              // Check if the description is currently truncated by looking for the "Read more" link
              if (descriptionEl.querySelector(".read-more-link")) {
                descriptionEl.innerHTML = processedDescription;
              }
            });
          }
        }
      });
      
      console.log(`Rendering completed: ${pageListings.length} listings displayed`);
      
      // Update favorite buttons after rendering
      if (typeof updateFavoriteButtons === 'function') {
        updateFavoriteButtons();
      }
      
      // Update report buttons visibility after rendering
      updateReportButtonsVisibility();
    }

    // Function to get listing data for favorites
    function getListingData(listing) {
      console.log('📋 Getting listing data for:', listing);
      
      // Verifica che il listing abbia un titolo valido
      if (!listing.title || listing.title.trim() === '') {
        console.error('❌ Listing has no valid title:', listing);
        return null;
      }
      
      const listingData = {
        id: listing.id || listing.link || listing.url || '',
        title: listing.title || listing.paraphrased_title || listing.name || 'Untitled',
        price: listing.price || listing.cost || 'N/A',
        zone: listing.zone || listing.zoneMacro || listing.location || 'N/A',
        zoneMacro: listing.zoneMacro || listing.zone || listing.location || 'N/A',
        imageUrl: listing.imageUrl || listing.image || listing.images?.[0] || '',
        link: listing.link || listing.url || '',
        description: listing.description || listing.paraphrased_overview || listing.overview || '',
        overview: listing.overview || listing.description || listing.paraphrased_overview || '',
        reliability: listing.reliability || 'N/A',
        reliabilityReason: listing.reliabilityReason || '',
        dateAdded: listing.dateAdded || new Date().toISOString(),
        city: currentCity || 'barcelona' // Aggiungi la città corrente
      };
      
      console.log('📋 Generated listing data:', listingData);
      return listingData;
    }

    // Function to update report buttons visibility
    function updateReportButtonsVisibility() {
      const reportButtons = document.querySelectorAll('.report-btn');
      const reportButtonsMobile = document.querySelectorAll('.report-btn-mobile');
      const isLoggedIn = window.auth && window.auth.currentUser;
      
      reportButtons.forEach(button => {
        button.style.display = isLoggedIn ? 'flex' : 'none';
      });
      
      reportButtonsMobile.forEach(button => {
        button.style.display = isLoggedIn ? 'block' : 'none';
        console.log(`📱 Mobile report button: ${isLoggedIn ? 'visible' : 'hidden'}, display: ${button.style.display}`);
      });
      
      console.log(`🚨 Updated ${reportButtons.length} desktop and ${reportButtonsMobile.length} mobile report buttons visibility: ${isLoggedIn ? 'visible' : 'hidden'}`);
    }

    // Global function to handle favorite clicks
    window.handleFavoriteClick = async function(auth, listingId) {
      console.log('🎯 Global handleFavoriteClick called with:', { auth, listingId });
      
      // Find the listing data - try multiple matching strategies
      let listing = allListings.find(l => l.id === listingId);
      if (!listing) {
        listing = allListings.find(l => l.link === listingId);
      }
      if (!listing) {
        listing = allListings.find(l => (l.id || l.link) === listingId);
      }
      
      if (!listing) {
        console.error('❌ Listing not found:', listingId);
        console.log('🔍 Available listings IDs:', allListings.slice(0, 5).map(l => ({ id: l.id, link: l.link })));
        return;
      }
      
      console.log('✅ Found listing:', listing);
      const listingData = getListingData(listing);
      console.log('📋 Listing data found:', listingData);
      
      if (!listingData) {
        console.error('❌ Could not generate listing data');
        return;
      }
      
      // Get the correct auth object
      let currentAuth = auth || window.auth || (window.firebase && window.firebase.auth);
      console.log('🔐 Initial auth object:', currentAuth);
      
      // If no auth object is available, try to get it from Firebase
      if (!currentAuth && window.currentUser) {
        console.log('🔐 No auth object found, but user is authenticated. Getting auth from Firebase...');
        try {
          const { getAuth } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
          const { getApp } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js");
          
          const app = getApp();
          currentAuth = getAuth(app);
          console.log('🔐 Retrieved auth from Firebase:', currentAuth);
        } catch (error) {
          console.error('❌ Error getting auth from Firebase:', error);
          return;
        }
      }
      
      if (!currentAuth) {
        console.error('❌ No auth object available');
        return;
      }
      
      // Import and call the favorites function
      try {
        const { handleFavoriteClick: favoritesHandler } = await import('./assets/js/favorites.js');
        console.log('🎯 Calling favorites handler with:', { currentAuth, listingId, listingData });
        await favoritesHandler(currentAuth, listingId, listingData);
      } catch (error) {
        console.error('❌ Error handling favorite click:', error);
      }
    };

    function updatePagination() {
      const paginationDiv = document.getElementById('pagination');
      
      // Check if user is logged in
      const isLoggedIn = currentUser !== null;
      
      // Limit listings for non-registered users only
      let listingsToShow = filteredListings;
      if (!isLoggedIn) {
        listingsToShow = filteredListings.slice(0, 15);
        console.log('🔒 Pagination limited to 15 listings for non-registered user');
      } else {
        console.log('✅ Pagination showing all listings for registered user');
      }
      
      const totalPages = Math.ceil(listingsToShow.length / itemsPerPage);
      
      if (totalPages <= 1) {
        paginationDiv.style.display = 'none';
        return;
      }
      
      paginationDiv.style.display = 'flex';
      
      const startIndex = (currentPage - 1) * itemsPerPage + 1;
      const endIndex = Math.min(currentPage * itemsPerPage, listingsToShow.length);
      
      const firstDisabled = currentPage === 1 ? 'disabled' : '';
      const prevDisabled = currentPage === 1 ? 'disabled' : '';
      const nextDisabled = currentPage === totalPages ? 'disabled' : '';
      const lastDisabled = currentPage === totalPages ? 'disabled' : '';
      
      paginationDiv.innerHTML = `
        <div class="pagination-info">
          <svg class="icon" viewBox="0 0 24 24" style="width: 18px; height: 18px; margin-right: 0.5rem;">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14,2 14,8 20,8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10,9 9,9 8,9"></polyline>
          </svg>
          Showing ${startIndex}-${endIndex} of ${listingsToShow.length} listings
          ${!isLoggedIn && filteredListings.length > 15 ? ` (${filteredListings.length} total available)` : ''}
        </div>
        <div class="pagination-buttons">
          <button class="pagination-btn" onclick="goToPage(1)" ${firstDisabled}>
            <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
              <polyline points="11,17 6,12 11,7"></polyline>
              <polyline points="18,17 13,12 18,7"></polyline>
            </svg>
            First
          </button>
          <button class="pagination-btn" onclick="goToPage(${currentPage - 1})" ${prevDisabled}>
            <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
              <polyline points="15,18 9,12 15,6"></polyline>
            </svg>
            Previous
          </button>
          ${generatePageNumbers(currentPage, totalPages)}
          <button class="pagination-btn" onclick="goToPage(${currentPage + 1})" ${nextDisabled}>
            Next
            <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
              <polyline points="9,18 15,12 9,6"></polyline>
            </svg>
          </button>
          <button class="pagination-btn" onclick="goToPage(${totalPages})" ${lastDisabled}>
            Last
            <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
              <polyline points="13,17 18,12 13,7"></polyline>
              <polyline points="6,17 11,12 6,7"></polyline>
            </svg>
          </button>
        </div>
      `;
    }

    function generatePageNumbers(current, total) {
      let pages = [];
      const maxVisible = 5;
      
      if (total <= maxVisible) {
        for (let i = 1; i <= total; i++) {
          pages.push(i);
        }
      } else {
        if (current <= 3) {
          for (let i = 1; i <= 4; i++) pages.push(i);
          pages.push('...');
          pages.push(total);
        } else if (current >= total - 2) {
          pages.push(1);
          pages.push('...');
          for (let i = total - 3; i <= total; i++) pages.push(i);
        } else {
          pages.push(1);
          pages.push('...');
          for (let i = current - 1; i <= current + 1; i++) pages.push(i);
          pages.push('...');
          pages.push(total);
        }
      }
      
      return pages.map(page => {
        if (page === '...') {
          return '<span style="padding: 0.875rem 1rem; color: #9ca3af; font-weight: 500;">...</span>';
        }
        const activeClass = page === current ? 'active' : '';
        return `<button class="pagination-btn ${activeClass}" onclick="goToPage(${page})">${page}</button>`;
      }).join('');
    }

    function goToPage(page) {
      const totalPages = Math.ceil(filteredListings.length / itemsPerPage);
      if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderListings();
        updatePagination();
        
        // Scroll to the listings section instead of top of page
        const listingsSection = document.getElementById('listings');
        if (listingsSection) {
          const listingsOffset = listingsSection.offsetTop - 100; // 100px offset for better visibility
          window.scrollTo({ top: listingsOffset, behavior: 'smooth' });
        } else {
          // Fallback to top if listings section not found
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      }
    }

    function changeItemsPerPage() {
      itemsPerPage = parseInt(document.getElementById('items-per-page').value);
      currentPage = 1;
      renderListings();
      updatePagination();
    }

    // Funzione per cambiare città (mostra la barra di ricerca)
    function changeCity() {
      // Controlli di sicurezza per tutti gli elementi
      const currentCityDisplayContainer = document.getElementById('current-city-display-container');
      const citySearchContainer = document.getElementById('city-search-container');
      const citySelect = document.getElementById('city-select');
      const searchBtn = document.getElementById('search-btn');
      
      // Nascondi il display della città corrente
      if (currentCityDisplayContainer) currentCityDisplayContainer.style.display = 'none';
      
      // Mostra la barra di ricerca
      if (citySearchContainer) citySearchContainer.style.display = 'flex';
      
      // Reset del selettore
      if (citySelect) citySelect.value = '';
      
      // Disabilita il pulsante di ricerca
      if (searchBtn) {
        searchBtn.style.opacity = '0.6';
        searchBtn.style.pointerEvents = 'none';
        searchBtn.style.animation = 'none';
      }
    }

    // Funzione per avviare la ricerca della città
    function startCitySearch(showNotification = true, scrollToResults = true) {
      console.log('🔍 startCitySearch called', { showNotification, scrollToResults });
      
      const selectedCity = document.getElementById('city-select').value;
      console.log('Selected city:', selectedCity);
      
      if (!selectedCity) {
        // Mostra feedback se nessuna città è selezionata
        showFeedback('Please select a city first', 'error');
        return;
      }
      
      console.log(`🔄 Starting search for ${selectedCity}`);
      
      // Controlli di sicurezza per tutti gli elementi
      const loading = document.getElementById('loading');
      const listings = document.getElementById('listings');
      const citySearchContainer = document.getElementById('city-search-container');
      const currentCityDisplayContainer = document.getElementById('current-city-display-container');
      const currentCityText = document.getElementById('current-city-text');
      const filters = document.getElementById('filters');
      const pagination = document.getElementById('pagination');
      
      // Mostra feedback visivo del cambio città solo se richiesto
      if (showNotification) {
        showCitySwitchFeedback(selectedCity);
      }
      
      // Mostra loading immediatamente
      if (loading) loading.style.display = 'block';
      if (listings) listings.innerHTML = '';
      
      // Salva la nuova città
      localStorage.setItem('selectedCity', selectedCity);
      saveUserCityPreference(selectedCity);
      
      // Aggiorna la città corrente
      currentCity = selectedCity;
      
      // Aggiorna l'URL senza ricaricare la pagina
      const url = new URL(window.location);
      url.searchParams.set('city', selectedCity);
      window.history.pushState({}, '', url);
      
      // Aggiorna il display
      updateCityTitle();
      
      // Nascondi la barra di ricerca e mostra il display della città solo se è un'azione manuale
      if (showNotification) {
        if (citySearchContainer) citySearchContainer.style.display = 'none';
        if (currentCityDisplayContainer) currentCityDisplayContainer.style.display = 'flex';
        if (currentCityText) currentCityText.textContent = getCityDisplayName(selectedCity);
      
        // Aggiorna il testo "Active listings" con un placeholder che verrà aggiornato dopo il caricamento
        const activeListingsText = currentCityDisplayContainer?.querySelector('span:last-of-type');
        if (activeListingsText) {
          activeListingsText.textContent = 'Loading listings...';
      }
      
        // Mostra i listings e i filtri
        if (listings) listings.style.display = 'block';
        if (filters) filters.style.display = 'block';
        if (pagination) pagination.style.display = 'block';
      }
      
      // Ricarica i dati per la nuova città con debounce
      clearTimeout(window.citySwitchTimeout);
      window.citySwitchTimeout = setTimeout(() => {
        console.log('🔄 Calling loadListingsForCity for city:', selectedCity);
        if (typeof loadListingsForCity === 'function') {
          loadListingsForCity(selectedCity, scrollToResults);
        } else {
          console.error('❌ loadListingsForCity function not found');
          showFeedback('Error loading listings', 'error');
        }
      }, 100); // Piccolo delay per evitare chiamate multiple
    }

    // Funzione per caricare gli annunci per una città specifica
    async function loadListingsForCity(city, scrollToResults = false) {
      try {
        console.log(`🔄 Loading listings for city: ${city}`);
        
        // Salva la città selezionata
        localStorage.setItem('selectedCity', city);
        saveUserCityPreference(city);
        
        // Aggiorna la città corrente
        currentCity = city;
        
        // Aggiorna l'URL senza ricaricare la pagina
        const url = new URL(window.location);
        url.searchParams.set('city', city);
        window.history.pushState({}, '', url);
        
        // Aggiorna il display
        updateCityTitle();
        
        // Mostra loading e assicurati che i listings siano visibili
        const loading = document.getElementById('loading');
        const listings = document.getElementById('listings');
        const filters = document.getElementById('filters');
        const pagination = document.getElementById('pagination');
        
        if (loading) loading.style.display = 'block';
        if (listings) {
          listings.innerHTML = '';
          listings.style.display = 'block';
        }
        if (filters) filters.style.display = 'block';
        if (pagination) pagination.style.display = 'block';
        
        // Controlla se abbiamo i dati in cache
        if (cityDataCache[city] && (Date.now() - cityDataCache[city].timestamp) < 30000) {
          console.log(`📦 Using cached data for ${city}`);
          const cachedData = cityDataCache[city].data;
          allListings = cachedData.results || [];
          window.totalRejectedCount = cachedData.totalRejectedCount || 0;
          
          if (loading) loading.style.display = 'none';
          setupEventListeners();
          populateFilters();
          applyFilters();
          updateStats();
          console.log(`✅ Listings loaded for ${city} (from cache)`);
          return;
        }
        
        // Carica i dati dal file JSON
        const response = await fetch(`public/data_${city}.json?t=${Date.now()}`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // Carica il contatore dei post scartati
        window.totalRejectedCount = data.totalRejectedCount || 0;
        
        // Check data structure
        if (data.results && Array.isArray(data.results)) {
          allListings = data.results;
        } else if (Array.isArray(data)) {
          allListings = data;
        } else {
          allListings = [];
        }
        
        // Salva in cache
        cityDataCache[city] = {
          data: data,
          timestamp: Date.now()
        };
        
        if (loading) loading.style.display = 'none';
        setupEventListeners();
        populateFilters();
        applyFilters();
        updateStats();
        
        console.log(`✅ Listings loaded for ${city}`);
        
        // Scroll ai risultati solo se richiesto
          if (scrollToResults) {
            setTimeout(() => {
              const listingsSection = document.getElementById('listings');
              if (listingsSection) {
                listingsSection.scrollIntoView({ 
                  behavior: 'smooth', 
                  block: 'start' 
                });
                console.log('📜 Scrolled to listings section');
              }
          }, 800);
          }
          
      } catch (error) {
        console.error('❌ Error loading listings for city:', city, error);
        if (loading) loading.style.display = 'none';
          showFeedback('Error loading listings', 'error');
        }
    }

    // Funzione per ottenere il nome di visualizzazione della città
    function getCityDisplayName(cityKey) {
      const cityNames = {
        'barcelona': 'Barcelona',
        'roma': 'Rome',
        'london': 'London'
      };
      return cityNames[cityKey] || cityKey;
    }

    // Funzione per aggiornare il numero di listings attivi nel display della città
    function updateActiveListingsCount() {
      const currentCityDisplayContainer = document.getElementById('current-city-display-container');
      if (!currentCityDisplayContainer || currentCityDisplayContainer.style.display === 'none') return;
      
      const activeListingsText = currentCityDisplayContainer.querySelector('span:last-of-type');
      if (!activeListingsText) return;
      
      const activeCount = filteredListings ? filteredListings.length : allListings.length;
      activeListingsText.textContent = `${activeCount} active listings`;
    }

    // Funzione per mostrare feedback
    function showFeedback(message, type = 'info') {
      const feedback = document.createElement('div');
      feedback.id = 'feedback-message';
      feedback.innerHTML = `
        <div style="
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: ${type === 'error' ? 'rgba(239, 68, 68, 0.9)' : 'rgba(0, 0, 0, 0.8)'};
          color: white;
          padding: 0.75rem 1.5rem;
          border-radius: 8px;
          font-weight: 500;
          font-size: 1rem;
          z-index: 10000;
          animation: feedbackFade 0.4s ease-out;
        ">
          ${message}
        </div>
      `;
      
      // Aggiungi CSS per l'animazione
      if (!document.getElementById('feedback-styles')) {
        const style = document.createElement('style');
        style.id = 'feedback-styles';
        style.textContent = `
          @keyframes feedbackFade {
            0% {
              opacity: 0;
              transform: translate(-50%, -50%) scale(0.9);
            }
            100% {
              opacity: 1;
              transform: translate(-50%, -50%) scale(1);
            }
          }
        `;
        document.head.appendChild(style);
      }
      
      // Aggiungi al DOM
      document.body.appendChild(feedback);
      
      // Rimuovi dopo 2 secondi
      setTimeout(() => {
        if (feedback.parentNode) {
          feedback.remove();
        }
      }, 2000);
    }
    
    // Funzione per mostrare feedback visivo del cambio città in stile Apple
    function showCitySwitchFeedback(newCity) {
      // Crea un elemento di feedback temporaneo
      const feedback = document.createElement('div');
      feedback.id = 'city-switch-feedback';
      feedback.innerHTML = `
        <div style="
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(255, 255, 255, 0.95);
          color: #1f2937;
          padding: 0.75rem 1.25rem;
          border-radius: 12px;
          font-weight: 500;
          font-size: 0.9rem;
          z-index: 10000;
          box-shadow: 
            0 4px 20px rgba(0, 0, 0, 0.12),
            0 2px 8px rgba(0, 0, 0, 0.08);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          display: flex;
          align-items: center;
          gap: 0.5rem;
          animation: appleNotificationSlide 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        ">
          <div style="
            width: 6px;
            height: 6px;
            background: #10B981;
            border-radius: 50%;
            flex-shrink: 0;
          "></div>
          <span>Switched to ${newCity === 'roma' ? 'Rome' : newCity.charAt(0).toUpperCase() + newCity.slice(1)}</span>
        </div>
      `;
      
      // Aggiungi CSS per l'animazione Apple
      if (!document.getElementById('apple-notification-styles')) {
        const style = document.createElement('style');
        style.id = 'apple-notification-styles';
        style.textContent = `
          @keyframes appleNotificationSlide {
            0% {
              opacity: 0;
              transform: translateX(-50%) translateY(-20px);
            }
            100% {
              opacity: 1;
              transform: translateX(-50%) translateY(0);
            }
          }
        `;
        document.head.appendChild(style);
      }
      
      // Aggiungi al DOM
      document.body.appendChild(feedback);
      
      // Rimuovi dopo 1 secondo
      setTimeout(() => {
        if (feedback.parentNode) {
          feedback.style.animation = 'citySwitchFade 0.3s ease-in reverse';
          setTimeout(() => {
            if (feedback.parentNode) {
              feedback.remove();
            }
          }, 300);
        }
      }, 1000);
    }
    


    // Chiudi dropdown quando si clicca fuori
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('city-dropdown-menu');
      const cityButton = document.querySelector('.city-badge');
      
      if (dropdown && !cityButton.contains(event.target) && !dropdown.contains(event.target)) {
        dropdown.style.display = 'none';
        document.querySelector('.dropdown-arrow').style.transform = 'rotate(0deg)';
      }
    });
    


    // Toast notification system
    function showToast(type, title, message, duration = 4000) {
      const container = document.getElementById('toast-container');
      if (!container) return;
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icon = type === 'success' ? '✓' : '✕';
      
      toast.innerHTML = `
        <div class="toast-icon">
          <span style="font-size: 12px; font-weight: bold;">${icon}</span>
        </div>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      `;
      
      container.appendChild(toast);
      
      // Trigger animation with haptic feedback on mobile
      setTimeout(() => {
        toast.classList.add('show');
        // Haptic feedback on mobile devices (no sound, just vibration)
        if ('vibrate' in navigator && type === 'success') {
          navigator.vibrate(50);
        }
      }, 10);
      
      // Auto remove after duration
      setTimeout(() => {
        if (toast.parentElement) {
          toast.classList.remove('show');
          setTimeout(() => {
            if (toast.parentElement) {
              toast.remove();
            }
          }, 400);
        }
      }, duration);
    }

    // Initialize application
    console.log("=== STARTING APPLICATION ===");
    
    // Load navbar and footer
    loadNavbar();
    loadFooter();
    
    // Listen for Firebase auth state changes
    console.log('🔍 Setting up Firebase auth listener in homepage...');
    console.log('🔥 Firebase available:', typeof firebase !== 'undefined');
    console.log('🔥 Firebase auth available:', typeof firebase !== 'undefined' && firebase.auth);
    console.log('🔥 Window firebase:', typeof window.firebase !== 'undefined');
    console.log('🔥 Window firebase auth:', typeof window.firebase !== 'undefined' && window.firebase.auth);
    
    if (typeof firebase !== 'undefined' && firebase.auth) {
      console.log('✅ Setting up Firebase auth state listener...');
      firebase.auth().onAuthStateChanged(function(user) {
        console.log('🔥 Firebase auth state changed:', user ? 'User logged in' : 'User logged out');
        if (user) {
          console.log('✅ Firebase user authenticated, showing profile icon');
          showProfileIcon();
        } else {
          console.log('❌ Firebase user not authenticated, showing sign in button');
          showSignInButton();
        }
      });
    } else if (typeof window.firebase !== 'undefined' && window.firebase.auth) {
      console.log('✅ Setting up Firebase auth state listener (window.firebase)...');
      window.firebase.auth().onAuthStateChanged(function(user) {
        console.log('🔥 Firebase auth state changed:', user ? 'User logged in' : 'User logged out');
        if (user) {
          console.log('✅ Firebase user authenticated, showing profile icon');
          showProfileIcon();
        } else {
          console.log('❌ Firebase user not authenticated, showing sign in button');
          showSignInButton();
        }
      });
    } else {
      console.log('❌ Firebase not available for auth listener in homepage');
    }
    
    // Wait for Firebase to be ready before showing auth button
    function waitForFirebase() {
      if (window.firebaseReady && typeof showAuthButton === 'function') {
        showAuthButton();
      } else {
        setTimeout(waitForFirebase, 50);
      }
    }
    waitForFirebase();
    
    // Inizializza tutto quando il DOM è caricato
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🚀 DOM loaded, initializing application...');
      
      // Genera fingerprint utente
      userFingerprint = generateUserFingerprint();
      
      // Inizializza l'interfaccia utente
      initializeUserInterface();
      
      // Configura gli event listeners per la selezione città
      handleCitySelection();
      
      // Se l'utente ha una preferenza, carica i dati
      if (hasUserPreference()) {
        currentCity = getCurrentCity();
        updateCityTitle();
        loadListings();
      }
      
      console.log('✅ Application initialization completed');
      
      // Rendi le funzioni accessibili globalmente
      window.startCitySearch = startCitySearch;
      window.changeCity = changeCity;
      window.loadListings = loadListings;
      
      console.log('🌐 Global functions registered:', {
        startCitySearch: typeof window.startCitySearch,
        changeCity: typeof window.changeCity,
        loadListings: typeof window.loadListings
      });
      
      // Magnifier effect
      const citySearchContainer = document.getElementById('city-search-container');
      const magnifierEffect = document.querySelector('.magnifier-effect');
      
      if (citySearchContainer && magnifierEffect) {
        citySearchContainer.addEventListener('mousemove', (e) => {
          const rect = citySearchContainer.getBoundingClientRect();
          const x = ((e.clientX - rect.left) / rect.width) * 100;
          const y = ((e.clientY - rect.top) / rect.height) * 100;
          
          magnifierEffect.style.setProperty('--mouse-x', x + '%');
          magnifierEffect.style.setProperty('--mouse-y', y + '%');
        });
        
        citySearchContainer.addEventListener('mouseenter', () => {
          magnifierEffect.style.opacity = '1';
        });
        
        citySearchContainer.addEventListener('mouseleave', () => {
          magnifierEffect.style.opacity = '0';
        });
      }
    });

    // Add some nice loading animations
    window.addEventListener('load', function() {
      document.body.style.opacity = '0';
      document.body.style.transition = 'opacity 0.5s ease';
      setTimeout(() => {
        document.body.style.opacity = '1';
      }, 100);
    });

    // Function to load navbar
    async function loadNavbar() {
      try {
        const response = await fetch('assets/navbar.html');
        if (response.ok) {
          const navbarHtml = await response.text();
          document.getElementById('navbar-container').innerHTML = navbarHtml;
          
          // Check if user is logged in and show appropriate UI
          setTimeout(() => {
            if (typeof checkUserAuthStatus === 'function') {
              console.log('🔄 Navbar loaded, checking user status...');
              checkUserAuthStatus();
            }
          }, 100);
        }
      } catch (error) {
        console.error('Error loading navbar:', error);
      }
    }

    // Function to load footer
    async function loadFooter() {
      try {
        const timestamp = new Date().getTime();
        const response = await fetch(`assets/footer.html?t=${timestamp}`);
        if (response.ok) {
          const footerHtml = await response.text();
          document.getElementById('footer-container').innerHTML = footerHtml;
        }
      } catch (error) {
        console.error('Error loading footer:', error);
      }
    }

    // Profile icon functions
    window.showProfileIcon = function() {
      console.log('🔄 Showing profile icon (homepage)...');
      
      const signInBtn = document.getElementById('navbar-signin-btn');
      const profileIcon = document.getElementById('navbar-profile-icon');
      const mobileSignInBtn = document.getElementById('mobile-signin-btn');
      const mobileProfileIcon = document.getElementById('mobile-profile-icon');
      
      console.log('📱 Desktop elements found:', !!signInBtn, !!profileIcon);
      console.log('📱 Mobile elements found:', !!mobileSignInBtn, !!mobileProfileIcon);
      
      if (signInBtn && profileIcon) {
        signInBtn.style.display = 'none';
        profileIcon.style.display = 'flex';
        console.log('✅ Desktop profile icon shown');
      }
      
      if (mobileSignInBtn && mobileProfileIcon) {
        mobileSignInBtn.style.display = 'none';
        mobileProfileIcon.style.display = 'flex';
        console.log('✅ Mobile profile icon shown');
      }
    }

    window.showSignInButton = function() {
      console.log('🔄 Showing sign in button (homepage)...');
      
      const signInBtn = document.getElementById('navbar-signin-btn');
      const profileIcon = document.getElementById('navbar-profile-icon');
      const mobileSignInBtn = document.getElementById('mobile-signin-btn');
      const mobileProfileIcon = document.getElementById('mobile-profile-icon');
      
      if (signInBtn && profileIcon) {
        signInBtn.style.display = 'flex';
        profileIcon.style.display = 'none';
      }
      
      if (mobileSignInBtn && mobileProfileIcon) {
        mobileSignInBtn.style.display = 'flex';
        mobileProfileIcon.style.display = 'none';
      }
    }

    function toggleProfileMenu() {
      console.log('👤 Profile menu clicked!');
      // Redirect to profile page
      window.location.href = '/profile.html';
    }

    // Function to check if user is logged in and show appropriate UI
    function checkUserAuthStatus() {
      console.log('🔍 Checking user authentication status...');
      
      // Check if Firebase auth is available and user is logged in
      let isLoggedIn = false;
      
      console.log('🔥 Firebase available:', typeof firebase !== 'undefined');
      console.log('🔥 Firebase auth available:', typeof firebase !== 'undefined' && firebase.auth);
      console.log('🔥 Window firebase:', typeof window.firebase !== 'undefined');
      console.log('🔥 Window firebase auth:', typeof window.firebase !== 'undefined' && window.firebase.auth);
      
      // Try to get Firebase auth user
      if (typeof firebase !== 'undefined' && firebase.auth) {
        const currentUser = firebase.auth().currentUser;
        console.log('🔥 Firebase current user:', currentUser);
        isLoggedIn = !!currentUser;
      } else if (typeof window.firebase !== 'undefined' && window.firebase.auth) {
        const currentUser = window.firebase.auth().currentUser;
        console.log('🔥 Window Firebase current user:', currentUser);
        isLoggedIn = !!currentUser;
      }
      
      // Fallback to localStorage if Firebase not available
      if (!isLoggedIn) {
        isLoggedIn = localStorage.getItem('userLoggedIn') === 'true';
        console.log('💾 localStorage userLoggedIn:', isLoggedIn);
      }
      
      console.log('👤 Final user logged in status:', isLoggedIn);
      
      if (isLoggedIn) {
        console.log('✅ User is authenticated, showing profile icon');
        showProfileIcon();
      } else {
        console.log('❌ User is not authenticated, showing sign in button');
        showSignInButton();
      }
    }

    // Interactive Header Magic ✨
    (function() {
      const header = document.querySelector('header');
      const particlesContainer = document.querySelector('.header-particles');
      const magneticField = document.querySelector('.magnetic-field');
      let particles = [];
      let mouseX = 0;
      let mouseY = 0;
      let isMouseInHeader = false;

      // Icon templates
      const iconTemplates = {
        house: `<svg viewBox="0 0 24 24" fill="currentColor" style="width: 100%; height: 100%;">
          <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
        </svg>`,
        radar: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 100%; height: 100%;">
          <circle cx="12" cy="12" r="10"/>
          <circle cx="12" cy="12" r="6"/>
          <circle cx="12" cy="12" r="2"/>
          <path d="M12 2v4M12 18v4M2 12h4M18 12h4"/>
        </svg>`,
        star: `<svg viewBox="0 0 24 24" fill="currentColor" style="width: 100%; height: 100%;">
          <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
        </svg>`
      };

      // Create main particles (attracted to cursor)
      function createParticles() {
        for (let i = 0; i < 25; i++) {
          const particle = document.createElement('div');
          particle.className = 'particle';
          particle.style.left = Math.random() * 100 + '%';
          particle.style.top = Math.random() * 100 + '%';
          particlesContainer.appendChild(particle);
          
          particles.push({
            element: particle,
            baseX: Math.random() * header.offsetWidth,
            baseY: Math.random() * header.offsetHeight,
            currentX: Math.random() * header.offsetWidth,
            currentY: Math.random() * header.offsetHeight,
            speed: 0.02 + Math.random() * 0.03
          });
        }
      }

      // Create ambient floating icons
      function createAmbientIcons() {
        const iconTypes = ['house', 'radar', 'star'];
        const positions = [
          // Top edge
          ...Array.from({length: 8}, (_, i) => ({
            x: (i / 7) * header.offsetWidth,
            y: 20 + Math.random() * 40
          })),
          // Bottom edge
          ...Array.from({length: 8}, (_, i) => ({
            x: (i / 7) * header.offsetWidth,
            y: header.offsetHeight - 60 + Math.random() * 40
          })),
          // Left edge
          ...Array.from({length: 4}, (_, i) => ({
            x: 20 + Math.random() * 40,
            y: 80 + (i / 3) * (header.offsetHeight - 160)
          })),
          // Right edge
          ...Array.from({length: 4}, (_, i) => ({
            x: header.offsetWidth - 60 + Math.random() * 40,
            y: 80 + (i / 3) * (header.offsetHeight - 160)
          }))
        ];

        positions.forEach((pos, index) => {
          const iconType = iconTypes[index % iconTypes.length];
          const ambientIcon = document.createElement('div');
          ambientIcon.className = `ambient-icon ${iconType}`;
          ambientIcon.innerHTML = iconTemplates[iconType];
          ambientIcon.style.left = pos.x + 'px';
          ambientIcon.style.top = pos.y + 'px';
          ambientIcon.style.color = iconType === 'house' ? '#10B981' : 
                                   iconType === 'radar' ? '#8B5CF6' : '#F59E0B';
          
          particlesContainer.appendChild(ambientIcon);
          
          // Add to particles array for attraction effect
          particles.push({
            element: ambientIcon,
            baseX: pos.x,
            baseY: pos.y,
            currentX: pos.x,
            currentY: pos.y,
            speed: 0.01 + Math.random() * 0.02,
            isAmbient: true
          });
        });
      }

      // Create icon effect (replaces sparkle)
      function createIconEffect(x, y) {
        const iconTypes = ['house', 'radar', 'star'];
        const randomType = iconTypes[Math.floor(Math.random() * iconTypes.length)];
        
        const iconElement = document.createElement('div');
        iconElement.className = `icon-particle ${randomType}`;
        iconElement.innerHTML = iconTemplates[randomType];
        iconElement.style.left = (x - 8) + 'px';
        iconElement.style.top = (y - 8) + 'px';
        particlesContainer.appendChild(iconElement);
        
        setTimeout(() => iconElement.classList.add('active'), 10);
        setTimeout(() => iconElement.remove(), 2000);
      }

      // Animate particles
      function animateParticles() {
        const time = Date.now() * 0.001;
        
        particles.forEach((particle, index) => {
          // Add unique phase offset for each particle
          const phaseOffset = index * 0.5;
          
          if (isMouseInHeader) {
            // Magnetic attraction to cursor
            const dx = mouseX - particle.currentX;
            const dy = mouseY - particle.currentY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance < 150) {
              const attractionStrength = particle.isAmbient ? 0.3 : 0.5;
              particle.currentX += dx * particle.speed * attractionStrength;
              particle.currentY += dy * particle.speed * attractionStrength;
              
              if (particle.isAmbient) {
                particle.element.classList.add('attracted');
              } else {
                particle.element.classList.add('active');
              }
            } else {
              // Smooth return to base position with organic movement
              const returnSpeed = 0.02;
              particle.currentX += (particle.baseX - particle.currentX) * returnSpeed;
              particle.currentY += (particle.baseY - particle.currentY) * returnSpeed;
              
              if (particle.isAmbient) {
                particle.element.classList.remove('attracted');
              } else {
                particle.element.classList.remove('active');
              }
            }
          } else {
            // Organic floating motion for all particles
            if (particle.isAmbient) {
              // Gentle, slow floating for ambient icons
              const floatX = Math.sin(time * 0.3 + phaseOffset) * 8 + 
                           Math.sin(time * 0.7 + phaseOffset * 2) * 3;
              const floatY = Math.cos(time * 0.4 + phaseOffset) * 6 + 
                           Math.cos(time * 0.8 + phaseOffset * 1.5) * 2;
              
              // Add subtle rotation
              const rotation = Math.sin(time * 0.2 + phaseOffset) * 10;
              particle.element.style.transform = `rotate(${rotation}deg)`;
              
              particle.currentX = particle.baseX + floatX;
              particle.currentY = particle.baseY + floatY;
              particle.element.classList.remove('attracted');
            } else {
              // More dynamic floating for main particles with multiple wave layers
              const floatX = Math.sin(time * 0.5 + phaseOffset) * 12 + 
                           Math.sin(time * 1.2 + phaseOffset * 3) * 4 +
                           Math.sin(time * 0.8 + phaseOffset * 0.7) * 2;
              const floatY = Math.cos(time * 0.6 + phaseOffset) * 10 + 
                           Math.cos(time * 1.1 + phaseOffset * 2.5) * 3 +
                           Math.cos(time * 0.9 + phaseOffset * 1.3) * 1.5;
              
              particle.currentX = particle.baseX + floatX;
              particle.currentY = particle.baseY + floatY;
              particle.element.classList.remove('active');
            }
            
            // Smooth boundary wrapping
            const margin = 50;
            if (particle.currentX < -margin) {
              particle.baseX = header.offsetWidth + margin;
            } else if (particle.currentX > header.offsetWidth + margin) {
              particle.baseX = -margin;
            }
            
            if (particle.currentY < -margin) {
              particle.baseY = header.offsetHeight + margin;
            } else if (particle.currentY > header.offsetHeight + margin) {
              particle.baseY = -margin;
            }
          }
          
          // Smooth position updates with easing
          const currentLeft = parseFloat(particle.element.style.left) || particle.currentX;
          const currentTop = parseFloat(particle.element.style.top) || particle.currentY;
          
          const easeSpeed = 0.1;
          const newLeft = currentLeft + (particle.currentX - currentLeft) * easeSpeed;
          const newTop = currentTop + (particle.currentY - currentTop) * easeSpeed;
          
          particle.element.style.left = newLeft + 'px';
          particle.element.style.top = newTop + 'px';
        });

        requestAnimationFrame(animateParticles);
      }

      // Mouse events
      header.addEventListener('mouseenter', () => {
        isMouseInHeader = true;
        magneticField.classList.add('active');
      });

      header.addEventListener('mouseleave', () => {
        isMouseInHeader = false;
        magneticField.classList.remove('active');
      });

      header.addEventListener('mousemove', (e) => {
        const rect = header.getBoundingClientRect();
        mouseX = e.clientX - rect.left;
        mouseY = e.clientY - rect.top;
        
        // Update magnetic field position
        magneticField.style.left = (mouseX - 50) + 'px';
        magneticField.style.top = (mouseY - 50) + 'px';
        
        // Create icons occasionally
        if (Math.random() < 0.08) {
          createIconEffect(mouseX, mouseY);
        }
      });

      // Click effect
      header.addEventListener('click', (e) => {
        const rect = header.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const clickY = e.clientY - rect.top;
        
        // Create burst of themed icons
        for (let i = 0; i < 8; i++) {
          setTimeout(() => {
            const angle = (i / 8) * Math.PI * 2;
            const distance = 30 + Math.random() * 20;
            const iconX = clickX + Math.cos(angle) * distance;
            const iconY = clickY + Math.sin(angle) * distance;
            createIconEffect(iconX, iconY);
          }, i * 50);
        }
      });

      // Initialize
      setTimeout(() => {
        if (header && particlesContainer) {
          createParticles();
          createAmbientIcons();
          animateParticles();
          console.log('✨ Header particles initialized');
        } else {
          console.error('❌ Header elements not found for particles');
        }
      }, 200);
    })();
  </script>
</body>
</html>