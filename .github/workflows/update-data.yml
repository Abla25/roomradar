name: Aggiorna dati e esegui script

on:
  schedule:
    - cron: "0 * * * *"   # ogni ora (al minuto 0)
  workflow_dispatch:      # esecuzione manuale dal tab Actions

permissions:
  contents: write   # serve per fare commit del data.json

jobs:
  update-and-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Setup Python per lo script principale
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Installa dipendenze Python
        run: pip install -r requirements.txt

      # Esegui lo script Python per Barcelona
      - name: Esegui script Python per Barcelona
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID_BARCELONA: ${{ secrets.NOTION_DATABASE_ID_BARCELONA }}
          NOTION_DATABASE_ID_ROMA: ${{ secrets.NOTION_DATABASE_ID_ROMA }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          # Feed RSS specifici per citt√†
          RSS_URL_BARCELONA_1: ${{ secrets.RSS_URL_BARCELONA_1 }}
          RSS_URL_BARCELONA_2: ${{ secrets.RSS_URL_BARCELONA_2 }}
          RSS_URL_BARCELONA_3: ${{ secrets.RSS_URL_BARCELONA_3 }}
          RSS_URL_BARCELONA_4: ${{ secrets.RSS_URL_BARCELONA_4 }}
          RSS_URL_BARCELONA_5: ${{ secrets.RSS_URL_BARCELONA_5 }}
          RSS_URL_BARCELONA_6: ${{ secrets.RSS_URL_BARCELONA_6 }}
          RSS_URL_ROMA_1: ${{ secrets.RSS_URL_ROMA_1 }}
          RSS_URL_ROMA_2: ${{ secrets.RSS_URL_ROMA_2 }}
          RSS_URL_ROMA_3: ${{ secrets.RSS_URL_ROMA_3 }}
          RSS_URL_ROMA_4: ${{ secrets.RSS_URL_ROMA_4 }}
          RSS_URL_ROMA_5: ${{ secrets.RSS_URL_ROMA_5 }}
          RSS_URL_ROMA_6: ${{ secrets.RSS_URL_ROMA_6 }}
        run: |
          echo "üèôÔ∏è Processing city: barcelona"
          CITY=barcelona python main.py
        continue-on-error: true

      # Esegui lo script Python per Roma
      - name: Esegui script Python per Roma
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID_BARCELONA: ${{ secrets.NOTION_DATABASE_ID_BARCELONA }}
          NOTION_DATABASE_ID_ROMA: ${{ secrets.NOTION_DATABASE_ID_ROMA }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          # Feed RSS specifici per citt√†
          RSS_URL_BARCELONA_1: ${{ secrets.RSS_URL_BARCELONA_1 }}
          RSS_URL_BARCELONA_2: ${{ secrets.RSS_URL_BARCELONA_2 }}
          RSS_URL_BARCELONA_3: ${{ secrets.RSS_URL_BARCELONA_3 }}
          RSS_URL_BARCELONA_4: ${{ secrets.RSS_URL_BARCELONA_4 }}
          RSS_URL_BARCELONA_5: ${{ secrets.RSS_URL_BARCELONA_5 }}
          RSS_URL_BARCELONA_6: ${{ secrets.RSS_URL_BARCELONA_6 }}
          RSS_URL_ROMA_1: ${{ secrets.RSS_URL_ROMA_1 }}
          RSS_URL_ROMA_2: ${{ secrets.RSS_URL_ROMA_2 }}
          RSS_URL_ROMA_3: ${{ secrets.RSS_URL_ROMA_3 }}
          RSS_URL_ROMA_4: ${{ secrets.RSS_URL_ROMA_4 }}
          RSS_URL_ROMA_5: ${{ secrets.RSS_URL_ROMA_5 }}
          RSS_URL_ROMA_6: ${{ secrets.RSS_URL_ROMA_6 }}
        run: |
          echo "üèôÔ∏è Processing city: roma"
          CITY=roma python main.py
        continue-on-error: true

      - name: Usa Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Aggiorna data.json per Barcelona da Notion
      - name: Esegui script Notion ‚Üí data.json per Barcelona
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID_BARCELONA: ${{ secrets.NOTION_DATABASE_ID_BARCELONA }}
          NOTION_DATABASE_ID_ROMA: ${{ secrets.NOTION_DATABASE_ID_ROMA }}
        run: |
          echo "üì• Fetching Notion data for barcelona"
          CITY=barcelona node scripts/fetch_notion.js
        continue-on-error: true

      # Aggiorna data.json per Roma da Notion
      - name: Esegui script Notion ‚Üí data.json per Roma
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID_BARCELONA: ${{ secrets.NOTION_DATABASE_ID_BARCELONA }}
          NOTION_DATABASE_ID_ROMA: ${{ secrets.NOTION_DATABASE_ID_ROMA }}
        run: |
          echo "üì• Fetching Notion data for roma"
          CITY=roma node scripts/fetch_notion.js
        continue-on-error: true

      # Debug: mostra lo stato dei file prima del commit
      - name: Debug - Mostra stato file
        run: |
          echo "=== Stato file prima del commit ==="
          ls -la
          echo "=== Contenuto rejected_urls_cache_barcelona.json ==="
          if [ -f "rejected_urls_cache_barcelona.json" ]; then
            ls -la rejected_urls_cache_barcelona.json
            echo "üìä Barcelona cache size: $(wc -c < rejected_urls_cache_barcelona.json) bytes"
          else
            echo "File rejected_urls_cache_barcelona.json NON TROVATO!"
          fi
          echo "=== Contenuto rejected_urls_cache_roma.json ==="
          if [ -f "rejected_urls_cache_roma.json" ]; then
            ls -la rejected_urls_cache_roma.json
            echo "üìä Roma cache size: $(wc -c < rejected_urls_cache_roma.json) bytes"
          else
            echo "File rejected_urls_cache_roma.json NON TROVATO!"
          fi
          echo "=== Contenuto public/data_barcelona.json ==="
          if [ -f "public/data_barcelona.json" ]; then
            ls -la public/data_barcelona.json
            echo "üìä Barcelona data size: $(wc -c < public/data_barcelona.json) bytes"
            echo "üìä Barcelona results count: $(jq '.results | length' public/data_barcelona.json 2>/dev/null || echo 'N/A')"
          else
            echo "File public/data_barcelona.json NON TROVATO!"
          fi
          echo "=== Contenuto public/data_roma.json ==="
          if [ -f "public/data_roma.json" ]; then
            ls -la public/data_roma.json
            echo "üìä Roma data size: $(wc -c < public/data_roma.json) bytes"
            echo "üìä Roma results count: $(jq '.results | length' public/data_roma.json 2>/dev/null || echo 'N/A')"
          else
            echo "File public/data_roma.json NON TROVATO!"
          fi

      # Forza il tracking dei file cache se esistono
      - name: Forza tracking file cache
        run: |
          if [ -f "rejected_urls_cache_barcelona.json" ]; then
            git add rejected_urls_cache_barcelona.json
            echo "‚úÖ File cache Barcelona aggiunto al tracking"
          else
            echo "‚ö†Ô∏è File cache Barcelona non trovato"
          fi
          if [ -f "rejected_urls_cache_roma.json" ]; then
            git add rejected_urls_cache_roma.json
            echo "‚úÖ File cache Roma aggiunto al tracking"
          else
            echo "‚ö†Ô∏è File cache Roma non trovato"
          fi

      # Pull delle modifiche remote prima del commit
      - name: Pull modifiche remote
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git pull origin main --rebase || echo "No remote changes to pull"

      - name: Commit e push se ci sono cambiamenti
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: aggiorna dati multi-citt√† e cache"
          file_pattern: |
            public/data_barcelona.json
            public/data_roma.json
            rejected_urls_cache_barcelona.json
            rejected_urls_cache_roma.json
          commit_user_name: 'GitHub Action'
          commit_user_email: 'action@github.com'
          commit_options: '--no-verify'
          push_options: '--force-with-lease'

      # Debug: verifica finale
      - name: Debug - Verifica finale
        run: |
          echo "=== Verifica finale ==="
          echo "File nel repository:"
          ls -la
          echo "Status Git:"
          git status
          echo "Ultimi commit:"
          git log --oneline -5
